{% extends "base.html" %}
{% block title %}Ловец Лидов{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/profile_edit.css') }}">
<style>
    /* Стили для новых модальных окон ловца лидов */
    .leadcatcher-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1050;
        overflow-x: hidden;
        overflow-y: auto;
        outline: 0;
    }
    .leadcatcher-modal.show {
        display: block;
    }
    .leadcatcher-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
    }
    .leadcatcher-modal-dialog {
        position: relative;
        width: 100%;
        max-width: 900px;
        margin: 30px auto;
        pointer-events: none;
    }
    .leadcatcher-modal-content {
        position: relative;
        display: flex;
        flex-direction: column;
        background-color: #252935;
        border: 1px solid #2a2e3a;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        pointer-events: auto;
        max-height: 85vh;
        overflow: hidden;
    }
    .leadcatcher-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 24px;
        padding-bottom: 0;
        background-color: #252935;
    }
    .leadcatcher-modal-title {
        margin: 0;
        font-size: 20px;
        font-weight: 500;
        color: #e0e0e0;
    }
    .btn-close {
        background: none;
        border: none;
        font-size: 28px;
        line-height: 1;
        color: #a0a0a0;
        cursor: pointer;
        padding: 0;
        margin: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        transition: all 0.2s;
    }
    .btn-close:hover {
        background-color: #3a3a3a;
        color: #ffffff;
    }
    .leadcatcher-modal-body {
        padding: 24px;
        display: flex;
        flex-direction: column;
        gap: 16px;
        flex-grow: 1;
        background: #252935;
        overflow-y: auto;
    }
    .leadcatcher-format-info {
        background-color: #1c1f28;
        padding: 14px 18px;
        border-radius: 8px;
        border-left: 4px solid #4067c5;
        font-size: 14px;
    }
    .leadcatcher-format-info p {
        margin: 0 0 10px 0;
        font-weight: 500;
        color: #e0e0e0;
    }
    .leadcatcher-format-info pre {
        margin: 0;
        font-family: 'Courier New', Courier, monospace;
        white-space: pre-wrap;
        word-break: break-all;
        color: #a0a0a0;
        font-size: 13px;
        line-height: 1.6;
    }
    .leadcatcher-textarea-wrapper {
        position: relative;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
    }
    .leadcatcher-textarea-container {
        position: relative;
        flex-grow: 1;
        display: flex;
        background-color: #1c1f28;
        border: 1px solid #2a2e3a;
        border-radius: 8px;
        overflow: hidden;
    }
    .line-numbers {
        background-color: #1a1d26;
        color: #6c757d;
        padding: 12px 12px 12px 8px;
        text-align: right;
        font-family: 'Courier New', Courier, monospace;
        font-size: 14px;
        line-height: 21px;
        user-select: none;
        border-right: 1px solid #2a2e3a;
        min-width: 50px;
        overflow: hidden;
        white-space: pre;
    }
    .leadcatcher-textarea {
        width: 100%;
        min-height: 350px;
        resize: none;
        padding: 12px 12px 12px 8px;
        font-family: 'Courier New', Courier, monospace;
        font-size: 14px;
        line-height: 21px;
        border: none;
        box-sizing: border-box;
        background-color: #1c1f28;
        color: #e0e0e0;
        flex-grow: 1;
        overflow-y: auto;
        overflow-x: auto;
    }
    .leadcatcher-textarea:focus {
        outline: none;
    }
    .leadcatcher-textarea::placeholder {
        color: #6c757d;
        opacity: 1;
    }
    .leadcatcher-modal-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 24px;
        background-color: #252935;
        border-top: 1px solid #2a2e3a;
    }
    .footer-left {
        display: flex;
        align-items: center;
        gap: 16px;
    }
    .search-toggle-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        background: linear-gradient(145deg, #5c8aff, #4c7cff);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 14px;
        font-weight: 500;
    }
    .search-toggle-btn:hover {
        background: linear-gradient(145deg, #4c7cff, #3f6fd3);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(92, 138, 255, 0.3);
    }
    .search-toggle-btn.active {
        background: linear-gradient(145deg, #3f6fd3, #2f5ba0);
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    .search-toggle-btn .search-icon {
        width: 16px;
        height: 16px;
    }
    .search-toggle-btn .search-text {
        white-space: nowrap;
    }
    .search-container {
        display: flex;
        align-items: center;
        background-color: #1c1f28;
        border: 1px solid #2a2e3a;
        border-radius: 8px;
        padding: 6px 12px;
        min-width: 280px;
        margin-left: 8px;
    }
    .search-input-wrapper {
        position: relative;
        display: flex;
        align-items: center;
        width: 100%;
    }
    .search-input-icon {
        color: #6c757d;
        margin-right: 8px;
        flex-shrink: 0;
        width: 16px;
        height: 16px;
    }
    .search-input {
        background: transparent;
        border: none;
        color: #e0e0e0;
        font-size: 14px;
        flex: 1;
        outline: none;
        padding: 4px 0;
    }
    .search-input::placeholder {
        color: #6c757d;
    }
    .clear-search-btn {
        background: none;
        border: none;
        color: #6c757d;
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        display: none;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        margin-left: 4px;
    }
    .clear-search-btn:hover {
        background-color: #2a2e3a;
        color: #e0e0e0;
    }
    .row-count {
        font-size: 14px;
        color: #a0a0a0;
        margin-left: 16px;
    }
</style>
{% endblock %}
{% block content %}
<div class="proxy-page">
    <h1 class="page-title">Ловец Лидов</h1>
    <!-- Кнопки материалов/файлов -->
    <div class="card">
        <div class="card-body">
            <div class="file-buttons-container">
                <button class="btn btn-light" id="btn-recipients">
                    Список получателей
                    <span class="section-button-counter ms-1" id="recipients-counter">0</span>
                </button>
                <button class="btn btn-light" id="btn-triggers">
                    Триггерные слова
                    <span class="section-button-counter ms-1" id="triggers-counter">0</span>
                </button>
                <button class="btn btn-light" id="btn-leadcatcher-results">
                    Результаты
                </button>
            </div>
        </div>
    </div>
    <!-- Убраны основные настройки: перенос в модальные окна списка получателей и триггеров -->
    <!-- Настройки ответов в чате -->
    <div class="card">
        <div class="card-body">
            <h3 class="subsection-title subsection-title-collapse collapsed" id="chatReplyHeader">
                Ответ в чате на триггер
                <svg class="svg-icon collapse-chevron" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4px" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"></path></svg>
            </h3>
            <div class="collapse" id="chatReplyOptions">
                <div class="options-container">
                    <div>
                        <label for="reply-in-chat" class="form-label">Включить ответ в чате</label>
                        <span class="help-icon" data-tooltip="Аккаунт будет автоматически отвечать на сообщения с триггерными словами прямо в чате, где было найдено сообщение.">
                            <svg class="svg-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                                <path d="M12 17h.01"></path>
                            </svg>
                        </span>
                        <div class="input-group">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="reply-in-chat" onchange="toggleSettings('reply-in-chat-settings')">
                            </div>
                        </div>
                    </div>
                    <div id="reply-in-chat-settings" class="sub-settings" style="display: none;">
                        <div>
                            <label for="chat-reply-message" class="form-label">Текст ответа</label>
                            <span class="help-icon" data-tooltip="Сообщение, которое будет отправлено в ответ на триггерное сообщение. Можно использовать переменные: {username} - имя пользователя, {message} - оригинальное сообщение.">
                                <svg class="svg-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                                    <path d="M12 17h.01"></path>
                                </svg>
                            </span>
                            <div class="input-group">
                                <textarea class="form-control" id="chat-reply-message" rows="3" placeholder="Привет! Мы заметили ваш вопрос..."></textarea>
                            </div>
                        </div>
                        <div>
                            <label for="chat-reply-delay" class="form-label">Задержка ответа (сек)</label>
                            <span class="help-icon" data-tooltip="Время ожидания перед отправкой ответа. Можно указать диапазон (например, 5-15) для случайной задержки между указанными значениями.">
                                <svg class="svg-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                                    <path d="M12 17h.01"></path>
                                </svg>
                            </span>
                            <div class="input-group" style="max-width: 200px">
                                <input class="form-control" id="chat-reply-delay" placeholder="5-15">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Настройки пересылки в лидохранилище -->
    <div class="card">
        <div class="card-body">
            <h3 class="subsection-title subsection-title-collapse collapsed" id="forwardToStorageHeader">
                Пересылка в чат-лидохранилище
                <svg class="svg-icon collapse-chevron" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4px" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"></path></svg>
            </h3>
            <div class="collapse" id="forwardToStorageOptions">
                <div class="options-container">
                    <div>
                        <label for="forward-to-storage" class="form-label">Включить пересылку в лидохранилище</label>
                        <span class="help-icon" data-tooltip="Все найденные лиды будут автоматически пересылаться в указанный чат-лидохранилище для дальнейшей работы.">
                            <svg class="svg-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                                <path d="M12 17h.01"></path>
                            </svg>
                        </span>
                        <div class="input-group">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="forward-to-storage" onchange="toggleSettings('forward-to-storage-settings')">
                            </div>
                        </div>
                    </div>
                    <div id="forward-to-storage-settings" class="sub-settings" style="display: none;">
                        <div>
                            <label for="storage-chat-link" class="form-label">Ссылка на чат лидохранилища</label>
                            <span class="help-icon" data-tooltip="Ссылка на чат или канал в Telegram, куда будут пересылаться все найденные лиды. Аккаунт должен быть участником этого чата.">
                                <svg class="svg-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                                    <path d="M12 17h.01"></path>
                                </svg>
                            </span>
                            <div class="input-group">
                                <input class="form-control" id="storage-chat-link" placeholder="https://t.me/your_storage_chat">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Настройки инициации диалога в личку -->
    <div class="card">
        <div class="card-body">
            <h3 class="subsection-title subsection-title-collapse collapsed" id="initiatePmHeader">
                Инициация диалога в личку
                <svg class="svg-icon collapse-chevron" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4px" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"></path></svg>
            </h3>
            <div class="collapse" id="initiatePmOptions">
                <div class="options-container">
                    <div>
                        <label for="initiate-pm" class="form-label">Включить инициацию диалога в личку</label>
                        <span class="help-icon" data-tooltip="Аккаунт будет автоматически писать пользователю в личные сообщения после обнаружения триггерного сообщения в чате.">
                            <svg class="svg-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                                <path d="M12 17h.01"></path>
                            </svg>
                        </span>
                        <div class="input-group">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="initiate-pm" onchange="toggleSettings('initiate-pm-settings')">
                            </div>
                        </div>
                    </div>
                    <div id="initiate-pm-settings" class="sub-settings" style="display: none;">
                        <div>
                            <label for="pm-message" class="form-label">Приветственное сообщение</label>
                            <span class="help-icon" data-tooltip="Сообщение, которое будет отправлено пользователю в личку. Можно использовать переменные: {username}, {message}, {chat_name} - название чата где был триггер.">
                                <svg class="svg-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                                    <path d="M12 17h.01"></path>
                                </svg>
                            </span>
                            <div class="input-group">
                                <textarea class="form-control" id="pm-message" rows="3" placeholder="Привет! Видел твой вопрос в чате..."></textarea>
                            </div>
                        </div>
                        <div>
                            <label for="include-original" class="form-label">Включать оригинальное сообщение</label>
                            <span class="help-icon" data-tooltip="При пересылке в личку будет также отправлено оригинальное сообщение пользователя для контекста.">
                                <svg class="svg-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                                    <path d="M12 17h.01"></path>
                                </svg>
                            </span>
                            <div class="input-group">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="include-original" checked>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label for="pm-delay" class="form-label">Задержка отправки (сек)</label>
                            <span class="help-icon" data-tooltip="Время ожидания перед отправкой сообщения в личку. Рекомендуется 10-30 секунд для естественности.">
                                <svg class="svg-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                                    <path d="M12 17h.01"></path>
                                </svg>
                            </span>
                            <div class="input-group" style="max-width: 200px">
                                <input class="form-control" id="pm-delay" placeholder="10-30">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Настройки добавления в тематический чат -->
    <div class="card">
        <div class="card-body">
            <h3 class="subsection-title subsection-title-collapse collapsed" id="addToGroupHeader">
                Добавление в тематический чат
                <svg class="svg-icon collapse-chevron" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4px" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"></path></svg>
            </h3>
            <div class="collapse" id="addToGroupOptions">
                <div class="options-container">
                    <div>
                        <label for="add-to-group" class="form-label">Включить добавление в тематический чат</label>
                        <span class="help-icon" data-tooltip="Аккаунт будет автоматически приглашать пользователей в указанный тематический чат после обнаружения триггерного сообщения.">
                            <svg class="svg-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                                <path d="M12 17h.01"></path>
                            </svg>
                        </span>
                        <div class="input-group">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="add-to-group" onchange="toggleSettings('add-to-group-settings')">
                            </div>
                        </div>
                    </div>
                    <div id="add-to-group-settings" class="sub-settings" style="display: none;">
                        <div>
                            <label for="target-group-link" class="form-label">Ссылка на чат</label>
                            <span class="help-icon" data-tooltip="Ссылка-приглашение на тематический чат. Аккаунт должен иметь права на приглашение пользователей в этот чат.">
                                <svg class="svg-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                                    <path d="M12 17h.01"></path>
                                </svg>
                            </span>
                            <div class="input-group">
                                <input class="form-control" id="target-group-link" placeholder="https://t.me/your_target_chat">
                            </div>
                        </div>
                        <div>
                            <label for="group-invite-message" class="form-label">Сообщение при приглашении</label>
                            <span class="help-icon" data-tooltip="Сообщение, которое будет отправлено вместе с приглашением в чат. Обычно содержит описание чата и приветствие.">
                                <svg class="svg-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                                    <path d="M12 17h.01"></path>
                                </svg>
                            </span>
                            <div class="input-group">
                                <textarea class="form-control" id="group-invite-message" rows="2" placeholder="Присоединяйтесь к нашему чату!"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Настройки AI-беседы -->
    <div class="card">
        <div class="card-body">
            <h3 class="subsection-title subsection-title-collapse collapsed" id="aiConversationHeader">
                AI-беседа после контакта
                <svg class="svg-icon collapse-chevron" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4px" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"></path></svg>
            </h3>
            <div class="collapse" id="aiConversationOptions">
                <div class="options-container">
                    <div>
                        <label for="ai-conversation" class="form-label">Включить AI-беседу</label>
                        <span class="help-icon" data-tooltip="После установления контакта с лидом, ИИ-агент продолжит беседу по заданному сценарию для квалификации лида или ответа на вопросы.">
                            <svg class="svg-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                                <path d="M12 17h.01"></path>
                            </svg>
                        </span>
                        <div class="input-group">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="ai-conversation" onchange="toggleSettings('ai-conversation-settings')">
                            </div>
                        </div>
                    </div>
                    <div id="ai-conversation-settings" class="sub-settings" style="display: none;">
                        <div>
                            <label for="ai-agent-select" class="form-label">Выберите ИИ агента</label>
                            <span class="help-icon" data-tooltip="Выберите заранее настроенного ИИ-агента, который будет вести беседу с лидом после установления контакта.">
                                <svg class="svg-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                                    <path d="M12 17h.01"></path>
                                </svg>
                            </span>
                            <div class="input-group">
                                <select class="form-select" id="ai-agent-select">
                                    <option value="">-- Выберите агента --</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Настройки лайкинга -->
    <div class="card">
        <div class="card-body">
            <h3 class="subsection-title subsection-title-collapse collapsed" id="likeTriggersHeader">
                Лайкать триггерные сообщения
                <svg class="svg-icon collapse-chevron" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4px" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"></path></svg>
            </h3>
            <div class="collapse" id="likeTriggersOptions">
                <div class="options-container">
                    <div>
                        <label for="like-triggers" class="form-label">Включить лайкинг триггерных сообщений</label>
                        <span class="help-icon" data-tooltip="Аккаунт будет автоматически ставить лайки на сообщения с триггерными словами для повышения вовлеченности и заметности.">
                            <svg class="svg-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                                <path d="M12 17h.01"></path>
                            </svg>
                        </span>
                        <div class="input-group">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="like-triggers" onchange="toggleSettings('like-triggers-settings')">
                            </div>
                        </div>
                    </div>
                    <div id="like-triggers-settings" class="sub-settings" style="display: none;">
                        <div>
                            <label for="like-delay" class="form-label">Задержка лайка (сек)</label>
                            <span class="help-icon" data-tooltip="Время ожидания перед поставкой лайка. Случайная задержка делает поведение аккаунта более естественным.">
                                <svg class="svg-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                                    <path d="M12 17h.01"></path>
                                </svg>
                            </span>
                            <div class="input-group" style="max-width: 200px">
                                <input class="form-control" id="like-delay" placeholder="5-20">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Кнопка запуска -->
<div class="start-task-btn-group">
    <button type="button" class="start-task-btn" id="start-leadcatcher-btn">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="6 3 20 12 6 21 6 3"></polygon></svg>
        Запустить Ловец Лидов
    </button>
</div>
<!-- Модальное окно настроек запуска -->
<div class="modal" id="leadcatcherTaskModal">
    <div class="modal-content">
        <div class="modal-body">
            <div class="options-container">
                <div class="mb-4">
                    <button class="btn btn-primary w-100" id="select-accounts-btn">
                        <span>Аккаунты</span>
                        <span class="mx-1 opacity-50">|</span>
                        <span id="accounts-picked-for-task-count">0</span>
                    </button>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-primary btn-lg" id="do-start-leadcatcher-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2"><path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z"></path><path d="m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z"></path><path d="M9 12H4s.55-3.03 2-4c1.62-1.08 5 0 5 0"></path><path d="M12 15v5s3.03-.55 4-2c1.08-1.62 0-5 0-5"></path></svg>
                <span>Запустить</span>
            </button>
        </div>
    </div>
</div>
<!-- Модальное окно выбора аккаунтов -->
<div class="modal" id="accountsModal" style="display: none;">
    <div class="modal-content" style="width: 90%; max-width: 1200px; height: 80vh;">
        <div class="modal-header">
            <h5 class="modal-title">Выбор аккаунтов</h5>
            <button type="button" class="modal-close" id="accountsModalClose">&times;</button>
        </div>
        <div class="modal-body" style="height: calc(100% - 120px); overflow: hidden;">
            <div class="proxy-container" style="height: 100%;">
                <div class="header-section">
                    <div class="table-controls">
                        <div class="account-folder-selector">
                            <button class="account-folder-btn active" id="all-folder-accounts">
                                <div class="account-count" data-count="0">0</div>
                                <div class="account-label">Все аккаунты</div>
                                <div class="active-indicator"></div>
                            </button>
                            <button class="account-folder-btn" id="working-folder-accounts">
                                <div class="account-count" data-count="0">0</div>
                                <div class="account-label">Для работы</div>
                                <div class="active-indicator"></div>
                            </button>
                            <button class="account-folder-btn" id="archive-folder-accounts">
                                <div class="account-count" data-count="0">0</div>
                                <div class="account-label">Архив</div>
                                <div class="active-indicator"></div>
                            </button>
                            <button class="account-folder-btn" id="no-spam-folder-accounts">
                                <div class="account-count" data-count="0">0</div>
                                <div class="account-label">Без спамблока</div>
                                <div class="active-indicator"></div>
                            </button>
                            <button class="account-folder-btn" id="with-spam-folder-accounts">
                                <div class="account-count" data-count="0">0</div>
                                <div class="account-label">Спамблок</div>
                                <div class="active-indicator"></div>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card mb-3">
                    <div class="card-body p-3 d-flex align-items-center">
                        <div class="d-flex gap-2">
                            <button class="btn btn-light" id="select-all-accounts-modal">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 7 17l-5-5"></path><path d="m22 10-7.5 7.5L13 16"></path></svg>
                            </button>
                            <button id="deselect-all-btn-modal" type="button" class="btn btn-light">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg>
                            </button>
                        </div>
                        <span class="text-muted ms-auto" id="accounts-count-label-modal">Показано аккаунтов: 0 / 0</span>
                    </div>
                </div>
                <div style="height: calc(100% - 200px); overflow-y: auto;">
                    <table id="accounts-table-modal" class="proxy-table">
                        <thead>
                            <tr>
                                <th class="selector-header"><input type="checkbox" id="select-all-checkbox-modal" class="select-all-checkbox"></th>
                                <th>#</th>
                                <th>Аватар</th>
                                <th><div class="sortable-header" data-sort="phone">Телефон<div class="sort-icons"><span class="sort-asc">▲</span><span class="sort-desc">▼</span></div></div></th>
                                <th><div class="sortable-header" data-sort="geo">Гео<div class="sort-icons"><span class="sort-asc">▲</span><span class="sort-desc">▼</span></div></div></th>
                                <th><div class="sortable-header" data-sort="status">Статус<div class="sort-icons"><span class="sort-asc">▲</span><span class="sort-desc">▼</span></div></div></th>
                                <th>Отлежка</th>
                                <th><div class="sortable-header" data-sort="role">Роль<div class="sort-icons"><span class="sort-asc">▲</span><span class="sort-desc">▼</span></div></div></th>
                                <th>Использован</th>
                                <th><div class="sortable-header" data-sort="name">Имя<div class="sort-icons"><span class="sort-asc">▲</span><span class="sort-desc">▼</span></div></div></th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" id="accountsModalCancel">Отмена</button>
            <button type="button" class="btn btn-primary" id="confirmAccountsSelection">Подтвердить (<span id="selected-count-modal">0</span>)</button>
        </div>
    </div>
</div>
<!-- Модальное окно: Список получателей -->
<div id="recipientsModal" class="leadcatcher-modal">
    <div class="leadcatcher-modal-overlay"></div>
    <div class="leadcatcher-modal-dialog">
        <div class="leadcatcher-modal-content">
            <div class="leadcatcher-modal-header">
                <h5 class="leadcatcher-modal-title">Список получателей</h5>
                <button type="button" class="btn-close" id="recipientsModalClose">&times;</button>
            </div>
            <div class="leadcatcher-modal-body">
                <div class="leadcatcher-format-info">
                    <p>Введите список чатов (по одной в строке):</p>
                    <pre>https://t.me/chatname
chatusername
https://t.me/joinchat/invite_link</pre>
                </div>
                <div class="leadcatcher-textarea-wrapper">
                    <div class="leadcatcher-textarea-container">
                        <div class="line-numbers" id="lineNumbersRecipients"></div>
                        <textarea
                            id="recipients-list"
                            class="leadcatcher-textarea"
                            placeholder="Введите ссылки или юзернеймы чатов..."
                        ></textarea>
                    </div>
                </div>
            </div>
            <div class="leadcatcher-modal-footer">
                <div class="footer-left">
                    <button class="search-toggle-btn" id="searchToggleRecipients">
                        <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                        <span class="search-text">Поиск</span>
                    </button>
                    <div class="search-container" id="searchContainerRecipients" style="display: none;">
                        <div class="search-input-wrapper">
                            <svg class="search-input-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="11" cy="11" r="8"></circle>
                                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                            </svg>
                            <input type="text" id="searchInputRecipients" class="search-input" placeholder="Введите текст для поиска...">
                            <button class="clear-search-btn" id="clearSearchRecipients" style="display: none;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <span class="row-count">Кол-во строк: <span id="recipientsLineCount">0</span></span>
                </div>
                <button class="btn btn-primary" id="recipientsModalSave">Сохранить</button>
            </div>
        </div>
    </div>
</div>
<!-- Модальное окно: Триггерные слова -->
<div id="triggersModal" class="leadcatcher-modal">
    <div class="leadcatcher-modal-overlay"></div>
    <div class="leadcatcher-modal-dialog">
        <div class="leadcatcher-modal-content">
            <div class="leadcatcher-modal-header">
                <h5 class="leadcatcher-modal-title">Триггерные слова</h5>
                <button type="button" class="btn-close" id="triggersModalClose">&times;</button>
            </div>
            <div class="leadcatcher-modal-body">
                <div class="leadcatcher-format-info">
                    <p>Введите список слов (через запятую):</p>
                    <pre>ключ, слово, фраза</pre>
                </div>
                <div class="leadcatcher-textarea-wrapper">
                    <div class="leadcatcher-textarea-container">
                        <div class="line-numbers" id="lineNumbersTriggers"></div>
                        <textarea
                            id="trigger-words"
                            class="leadcatcher-textarea"
                            placeholder="Введите триггерные слова через запятую..."
                        ></textarea>
                    </div>
                </div>
            </div>
            <div class="leadcatcher-modal-footer">
                <div class="footer-left">
                    <button class="search-toggle-btn" id="searchToggleTriggers">
                        <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                        <span class="search-text">Поиск</span>
                    </button>
                    <div class="search-container" id="searchContainerTriggers" style="display: none;">
                        <div class="search-input-wrapper">
                            <svg class="search-input-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="11" cy="11" r="8"></circle>
                                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                            </svg>
                            <input type="text" id="searchInputTriggers" class="search-input" placeholder="Введите текст для поиска...">
                            <button class="clear-search-btn" id="clearSearchTriggers" style="display: none;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <span class="row-count">Кол-во слов: <span id="triggersLineCount">0</span></span>
                </div>
                <button class="btn btn-primary" id="triggersModalSave">Сохранить</button>
            </div>
        </div>
    </div>
</div>
<div id="customTooltip" class="custom-tooltip"></div>
<script>
// Реиспользование логики модалок и таблицы аккаунтов из parsing.html
let selectedAccounts = new Set();
let allAccounts = [];
let currentFolder = 'all';
let currentSpamFilter = null;
let currentSort = { field: null, direction: 'asc' };
let searchFilter = '';
let roleFilter = '';
let geoFilter = '';
let statusFilter = '';

// --- Новые функции для работы с модальными окнами списка получателей/триггеров ---
// --- Структура данных для хранения списков ---
let leadcatcherLists = {
    recipients: [],
    triggers: []
};

// --- Система уведомлений ---
class NotificationSystem {
    constructor() {
        this.container = null;
        this.init();
    }
    init() {
        this.container = document.createElement('div');
        this.container.className = 'notification-container';
        document.body.appendChild(this.container);
    }
    show(options) {
        const {
            title,
            message,
            type = 'info',
            duration = 5000
        } = options;
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        const iconSvg = this.getIcon(type);
        notification.innerHTML = `
            <div class="notification-icon">
                ${iconSvg}
            </div>
            <div class="notification-content">
                <div class="notification-title">${title}</div>
                <div class="notification-message">${message}</div>
            </div>
            <button class="notification-close">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        `;
        this.container.appendChild(notification);
        setTimeout(() => {
            notification.classList.add('show');
        }, 10);
        const closeBtn = notification.querySelector('.notification-close');
        closeBtn.addEventListener('click', () => {
            this.hide(notification);
        });
        if (duration > 0) {
            setTimeout(() => {
                this.hide(notification);
            }, duration);
        }
        return notification;
    }
    hide(notification) {
        notification.classList.remove('show');
        notification.classList.add('hide');
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 400);
    }
    getIcon(type) {
        const icons = {
            success: `
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#28a745" stroke-width="2">
                    <path d="M20 6L9 17l-5-5"/>
                </svg>
            `,
            error: `
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#dc3545" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="15" y1="9" x2="9" y2="15"></line>
                    <line x1="9" y1="9" x2="15" y2="15"></line>
                </svg>
            `,
            warning: `
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ffc107" stroke-width="2">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                    <line x1="12" y1="9" x2="12" y2="13"></line>
                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>
            `,
            info: `
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#5c8aff" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="16" x2="12" y2="12"></line>
                    <line x1="12" y1="8" x2="12.01" y2="8"></line>
                </svg>
            `
        };
        return icons[type] || icons.info;
    }
    success(title, message, duration = 5000) {
        return this.show({ title, message, type: 'success', duration });
    }
    error(title, message, duration = 5000) {
        return this.show({ title, message, type: 'error', duration });
    }
    warning(title, message, duration = 5000) {
        return this.show({ title, message, type: 'warning', duration });
    }
    info(title, message, duration = 5000) {
        return this.show({ title, message, type: 'info', duration });
    }
}
const notifications = new NotificationSystem();

// --- Функции для работы с модальными окнами ---
function openModal(modalId, listKey, textareaId, lineNumbersId, lineCountId) {
    const modal = document.getElementById(modalId);
    const textarea = document.getElementById(textareaId);
    modal.classList.add('show');
    // Загружаем оригинальный список при открытии
    if (listKey === 'triggers') {
        textarea.value = leadcatcherLists[listKey].join(', ');
    } else {
        textarea.value = leadcatcherLists[listKey].join('\n');
    }
    updateLineNumbers(lineNumbersId, textareaId);
    updateLineCount(lineCountId, textareaId, listKey);
    resetSearch(listKey);
}

function closeModal(modalId, listKey) {
    const modal = document.getElementById(modalId);
    modal.classList.remove('show');
    resetSearch(listKey);
}

function updateLineNumbers(lineNumbersId, textareaId) {
    const textarea = document.getElementById(textareaId);
    const lineNumbers = document.getElementById(lineNumbersId);
    const lineCount = textarea.value.split('\n').length;
    let numbers = [];
    for (let i = 1; i <= lineCount; i++) {
        numbers.push(i);
    }
    lineNumbers.textContent = numbers.join('\n');
    lineNumbers.scrollTop = textarea.scrollTop;
}

function updateLineCount(lineCountId, textareaId, listKey) {
    const textarea = document.getElementById(textareaId);
    let count = 0;
    if (listKey === 'triggers') {
        const text = textarea.value.trim();
        count = text ? text.split(',').map(s=>s.trim()).filter(Boolean).length : 0;
    } else {
        const lines = textarea.value.split('\n').filter(line => line.trim() !== '');
        count = lines.length;
    }
    document.getElementById(lineCountId).textContent = count;
    // Обновляем соответствующий счетчик кнопки
    if (lineCountId === 'recipientsLineCount') {
        document.getElementById('recipients-counter').textContent = count;
    } else if (lineCountId === 'triggersLineCount') {
        document.getElementById('triggers-counter').textContent = count;
    }
}

// --- Функции поиска для каждого модального окна ---
let searchStates = {
    recipients: { active: false, originalList: [] },
    triggers: { active: false, originalList: [] }
};

function toggleSearch(listKey) {
    if (searchStates[listKey].active) {
        hideSearch(listKey);
    } else {
        showSearch(listKey);
    }
}

function showSearch(listKey) {
    const searchContainerId = `searchContainer${listKey.charAt(0).toUpperCase() + listKey.slice(1)}`;
    const searchToggleBtnId = `searchToggle${listKey.charAt(0).toUpperCase() + listKey.slice(1)}`;
    const searchInputId = `searchInput${listKey.charAt(0).toUpperCase() + listKey.slice(1)}`;
    const searchContainer = document.getElementById(searchContainerId);
    const searchToggleBtn = document.getElementById(searchToggleBtnId);
    const searchInput = document.getElementById(searchInputId);

    searchContainer.style.display = 'block';
    searchToggleBtn.classList.add('active');
    searchStates[listKey].active = true;
    setTimeout(() => {
        searchInput.focus();
    }, 100);
}

function hideSearch(listKey) {
    const searchContainerId = `searchContainer${listKey.charAt(0).toUpperCase() + listKey.slice(1)}`;
    const searchToggleBtnId = `searchToggle${listKey.charAt(0).toUpperCase() + listKey.slice(1)}`;
    const searchContainer = document.getElementById(searchContainerId);
    const searchToggleBtn = document.getElementById(searchToggleBtnId);

    searchContainer.style.display = 'none';
    searchToggleBtn.classList.remove('active');
    searchStates[listKey].active = false;
    resetSearch(listKey);
}

function performSearch(listKey) {
    const searchInputId = `searchInput${listKey.charAt(0).toUpperCase() + listKey.slice(1)}`;
    const textareaId = `${listKey}Textarea`;
    const clearBtnId = `clearSearch${listKey.charAt(0).toUpperCase() + listKey.slice(1)}`;
    const searchInput = document.getElementById(searchInputId);
    const searchTerm = searchInput.value.toLowerCase().trim();
    const textarea = document.getElementById(textareaId);
    const clearBtn = document.getElementById(clearBtnId);

    clearBtn.style.display = searchTerm ? 'flex' : 'none';

    if (searchTerm === '') {
        textarea.value = searchStates[listKey].originalList.join('\n');
    } else {
        const filteredList = searchStates[listKey].originalList.filter(line =>
            line.toLowerCase().includes(searchTerm)
        );
        textarea.value = filteredList.join('\n');
    }
    const lineCountId = `${listKey}LineCount`;
    updateLineCount(lineCountId, textareaId, listKey);
}

function resetSearch(listKey) {
    const searchInputId = `searchInput${listKey.charAt(0).toUpperCase() + listKey.slice(1)}`;
    const textareaId = `${listKey}Textarea`;
    const clearBtnId = `clearSearch${listKey.charAt(0).toUpperCase() + listKey.slice(1)}`;
    const searchInput = document.getElementById(searchInputId);
    const clearBtn = document.getElementById(clearBtnId);
    const textarea = document.getElementById(textareaId);

    searchInput.value = '';
    clearBtn.style.display = 'none';
    // Восстанавливаем оригинальный список
    if (listKey === 'triggers') {
        textarea.value = leadcatcherLists[listKey].join(', ');
    } else {
        textarea.value = leadcatcherLists[listKey].join('\n');
    }
    const lineCountId = `${listKey}LineCount`;
    updateLineCount(lineCountId, textareaId, listKey);
}

function saveList(listKey, textareaId, modalId) {
    const textarea = document.getElementById(textareaId);
    // Если поиск активен, сначала сбрасываем его
    const searchInputId = `searchInput${listKey.charAt(0).toUpperCase() + listKey.slice(1)}`;
    if (searchStates[listKey].active && document.getElementById(searchInputId).value.trim() !== '') {
        resetSearch(listKey);
    }
    const list = textarea.value.trim();
    if (list) {
        console.log(`Сохранение списка ${listKey}:`, list);
        if (listKey === 'triggers') {
            leadcatcherLists[listKey] = list.split(',').map(s => s.trim()).filter(Boolean);
        } else {
            leadcatcherLists[listKey] = list.split('\n');
        }
        notifications.success('Успешно!', `Список ${listKey} успешно сохранен`, 3000);
    } else {
        notifications.warning('Внимание', `Список ${listKey} пуст`, 3000);
    }
    closeModal(modalId, listKey);
    // Обновляем счетчик при сохранении
    const lineCountId = `${listKey}LineCount`;
    updateLineCount(lineCountId, textareaId, listKey);
}

function showModal(modalId) {
    document.getElementById(modalId).classList.add('show');
    document.getElementById(modalId).style.display = 'block';
}
function hideModal(modalId) {
    document.getElementById(modalId).classList.remove('show');
    setTimeout(() => { document.getElementById(modalId).style.display = 'none'; }, 1);
}
function updateSelectedAccountsCount() {
    const el = document.getElementById('accounts-picked-for-task-count');
    if (el) el.textContent = selectedAccounts.size;
    const el2 = document.getElementById('selected-count-modal');
    if (el2) el2.textContent = selectedAccounts.size;
}
function selectAllAccountsInModal() {
    document.querySelectorAll('.account-checkbox').forEach(checkbox => {
        const accountId = checkbox.getAttribute('data-account-id');
        selectedAccounts.add(accountId);
        checkbox.checked = true;
    });
    updateSelectedAccountsCount();
}
function deselectAllAccountsInModal() {
    selectedAccounts.clear();
    document.querySelectorAll('.account-checkbox').forEach(checkbox => { checkbox.checked = false; });
    updateSelectedAccountsCount();
}
async function loadAccounts(folder = 'all') {
    try {
        const response = await fetch('/get_accounts', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ folder }) });
        if (!response.ok) throw new Error('Ошибка загрузки аккаунтов');
        allAccounts = await response.json();
        renderAccountsTable();
        updateAccountsCount();
    } catch (e) { console.error(e); }
}
function getStatusClass(status) {
    switch (status) {
        case 'alive': return 'alive';
        case 'dead': return 'dead';
        case 'spam_block': return 'spam-block';
        default: return 'unknown';
    }
}
function getStatusText(status) {
    switch (status) {
        case 'alive': return 'Без ограничений';
        case 'dead': return 'Мертв';
        case 'spam_block': return 'Спам блок';
        default: return 'Неизвестно';
    }
}
function getCountryData(){ return { RU:{name:'Россия'}, UA:{name:'Украина'}, KZ:{name:'Казахстан'}, US:{name:'США'} }; }
function getCountryInfo(code){ const m=getCountryData(); return m[code]||{name:code||'Неизвестно'}; }
function getFlagEmoji(code){ if(!code) return '🏳️'; const cps=code.toUpperCase().split('').map(c=>127397+c.charCodeAt(0)); try{ return String.fromCodePoint(...cps);}catch(e){return '🏳️';}}
function renderAccountsTable() {
    const tbody = document.querySelector('#accounts-table-modal tbody');
    if (!tbody) return;
    tbody.innerHTML = (allAccounts || []).map((account, index) => {
        const fullName = `${account.first_name || ''} ${account.last_name || ''}`.trim();
        const countryInfo = getCountryInfo(account.geo);
        const flagEmoji = getFlagEmoji(account.geo);
        return `
            <tr data-account-id="${account.id}" class="account-row">
                <td><input type="checkbox" class="account-checkbox" data-account-id="${account.id}" ${selectedAccounts.has(account.id) ? 'checked' : ''}></td>
                <td>${index + 1}</td>
                <td class="avatar-cell"><div class="avatar-placeholder">${(account.first_name||account.last_name||'?').toString().charAt(0).toUpperCase()}</div></td>
                <td>${account.phone || ''}</td>
                <td><div class="geo-cell" title="${countryInfo.name}"><span class="country-flag">${flagEmoji}</span><span class="country-code">${account.geo||''}</span></div></td>
                <td><span class="status-badge ${getStatusClass(account.status)}">${getStatusText(account.status)}</span></td>
                <td class="rest-period" data="${account.register_time}">${account.rest_until || '-'}</td>
                <td>${account.role || ''}</td>
                <td>${account.last_used || 'Нет'}</td>
                <td>${fullName || ''}</td>
            </tr>
        `;
    }).join('');
    document.querySelectorAll('.account-checkbox').forEach(cb => {
        cb.addEventListener('change', function(){
            const id = this.dataset.accountId;
            if (this.checked) selectedAccounts.add(id); else selectedAccounts.delete(id);
            updateSelectedAccountsCount();
        });
    });
}
function updateAccountsCount(){
    const total = allAccounts.length;
    const displayed = document.querySelectorAll('#accounts-table-modal tbody tr').length;
    const el = document.getElementById('accounts-count-label-modal');
    if (el) el.textContent = `Показано аккаунтов: ${displayed} / ${total}`;
}
// Тогглы секций
function toggleSection(headerId, contentId) {
    const content = document.getElementById(contentId);
    const header = document.getElementById(headerId);
    const chevron = header?.querySelector('.collapse-chevron');
    if (!content || !header || !chevron) return;
    content.classList.toggle('show');
    header.classList.toggle('collapsed');
    chevron.classList.toggle('rotated');
}
// Функция для переключения настроек
function toggleSettings(settingsId) {
    const settings = document.getElementById(settingsId);
    if (settings) {
        settings.style.display = settings.style.display === 'none' ? 'block' : 'none';
    }
}
document.addEventListener('DOMContentLoaded', function(){
    // --- Обработчики для кнопок открытия модальных окон ---
    document.getElementById('btn-recipients').addEventListener('click', function() {
        openModal('recipientsModal', 'recipients', 'recipients-list', 'lineNumbersRecipients', 'recipientsLineCount');
    });
    document.getElementById('btn-triggers').addEventListener('click', function() {
        openModal('triggersModal', 'triggers', 'trigger-words', 'lineNumbersTriggers', 'triggersLineCount');
    });

    // --- Обработчики для кнопок закрытия модальных окон ---
    document.getElementById('recipientsModalClose').addEventListener('click', function() { closeModal('recipientsModal', 'recipients'); });
    document.getElementById('triggersModalClose').addEventListener('click', function() { closeModal('triggersModal', 'triggers'); });

    // --- Обработчики для кнопок сохранения ---
    document.getElementById('recipientsModalSave').addEventListener('click', function() { saveList('recipients', 'recipients-list', 'recipientsModal'); });
    document.getElementById('triggersModalSave').addEventListener('click', function() { saveList('triggers', 'trigger-words', 'triggersModal'); });

    // --- Инициализация для каждого текстового поля ---
    const textareas = [
        { id: 'recipients-list', lineNumbersId: 'lineNumbersRecipients', listKey: 'recipients', counterId: 'recipients-counter' },
        { id: 'trigger-words', lineNumbersId: 'lineNumbersTriggers', listKey: 'triggers', counterId: 'triggers-counter' }
    ];

    textareas.forEach(item => {
        const textarea = document.getElementById(item.id);
        const lineNumbers = document.getElementById(item.lineNumbersId);

        updateLineNumbers(item.lineNumbersId, item.id);

        textarea.addEventListener('scroll', function() {
            lineNumbers.scrollTop = this.scrollTop;
        });

        textarea.addEventListener('input', function() {
            if (!searchStates[item.listKey].active || document.getElementById(`searchInput${item.listKey.charAt(0).toUpperCase() + item.listKey.slice(1)}`).value.trim() === '') {
                if (item.listKey === 'triggers') {
                    leadcatcherLists[item.listKey] = this.value.split(',').map(s => s.trim()).filter(Boolean);
                } else {
                    leadcatcherLists[item.listKey] = this.value.split('\n');
                }
            }
            updateLineCount(`${item.listKey}LineCount`, item.id, item.listKey);
        });

        textarea.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                setTimeout(() => updateLineNumbers(item.lineNumbersId, item.id), 0);
            }
        });

        // Обработчики поиска
        const searchInput = document.getElementById(`searchInput${item.listKey.charAt(0).toUpperCase() + item.listKey.slice(1)}`);
        searchInput.addEventListener('input', function() { performSearch(item.listKey); });
        searchInput.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                hideSearch(item.listKey);
            }
        });

        const clearSearchBtn = document.getElementById(`clearSearch${item.listKey.charAt(0).toUpperCase() + item.listKey.slice(1)}`);
        clearSearchBtn.addEventListener('click', function() { resetSearch(item.listKey); });

        const searchToggleBtn = document.getElementById(`searchToggle${item.listKey.charAt(0).toUpperCase() + item.listKey.slice(1)}`);
        searchToggleBtn.addEventListener('click', function() { toggleSearch(item.listKey); });

        // Закрытие по оверлею
        const overlay = document.querySelector(`#${item.listKey.charAt(0).toUpperCase() + item.listKey.slice(1)}Modal .leadcatcher-modal-overlay`);
        if (overlay) {
            overlay.addEventListener('click', function() { closeModal(`${item.listKey.charAt(0).toUpperCase() + item.listKey.slice(1)}Modal`, item.listKey); });
        }
    });

    // Инициализируем счетчики при загрузке
    updateLineCount('recipientsLineCount', 'recipients-list', 'recipients');
    updateLineCount('triggersLineCount', 'trigger-words', 'triggers');

    // Кнопка запуска
    document.getElementById('start-leadcatcher-btn').addEventListener('click', function(){ showModal('leadcatcherTaskModal'); });
    document.getElementById('leadcatcherTaskModal').addEventListener('click', function(e){ if (e.target === this) hideModal('leadcatcherTaskModal'); });
    // Открытие выбора аккаунтов
    document.getElementById('select-accounts-btn').addEventListener('click', function(){
        hideModal('leadcatcherTaskModal');
        showModal('accountsModal');
        loadAccounts();
    });
    // Закрытие модалки аккаунтов
    document.getElementById('accountsModalClose').addEventListener('click', () => hideModal('accountsModal'));
    document.getElementById('accountsModalCancel').addEventListener('click', () => hideModal('accountsModal'));
    document.getElementById('accountsModal').addEventListener('click', function(e){ if (e.target === this) hideModal('accountsModal'); });
    document.getElementById('confirmAccountsSelection').addEventListener('click', function(){ hideModal('accountsModal'); showModal('leadcatcherTaskModal'); });
    // Селекты папок и спам фильтров
    document.getElementById('all-folder-accounts')?.addEventListener('click', () => { currentFolder='all'; loadAccounts('all'); });
    document.getElementById('working-folder-accounts')?.addEventListener('click', () => { currentFolder='working'; loadAccounts('working'); });
    document.getElementById('archive-folder-accounts')?.addEventListener('click', () => { currentFolder='archive'; loadAccounts('archive'); });
    document.getElementById('no-spam-folder-accounts')?.addEventListener('click', () => { currentSpamFilter='no-spam'; loadAccounts(currentFolder); });
    document.getElementById('with-spam-folder-accounts')?.addEventListener('click', () => { currentSpamFilter='with-spam'; loadAccounts(currentFolder); });
    // Выделение/снятие выделения
    document.getElementById('select-all-accounts-modal').addEventListener('click', selectAllAccountsInModal);
    document.getElementById('deselect-all-btn-modal').addEventListener('click', deselectAllAccountsInModal);
    const selectAllCheckbox = document.getElementById('select-all-checkbox-modal');
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function(){ this.checked ? selectAllAccountsInModal() : deselectAllAccountsInModal(); });
    }
    // Тогглы секций
    document.getElementById('chatReplyHeader').addEventListener('click', () => toggleSection('chatReplyHeader','chatReplyOptions'));
    document.getElementById('forwardToStorageHeader').addEventListener('click', () => toggleSection('forwardToStorageHeader','forwardToStorageOptions'));
    document.getElementById('initiatePmHeader').addEventListener('click', () => toggleSection('initiatePmHeader','initiatePmOptions'));
    document.getElementById('addToGroupHeader').addEventListener('click', () => toggleSection('addToGroupHeader','addToGroupOptions'));
    document.getElementById('aiConversationHeader').addEventListener('click', () => toggleSection('aiConversationHeader','aiConversationOptions'));
    document.getElementById('likeTriggersHeader').addEventListener('click', () => toggleSection('likeTriggersHeader','likeTriggersOptions'));
    // Запуск задачи
    document.getElementById('do-start-leadcatcher-btn').addEventListener('click', function(){
        const selectedAccountIds = Array.from(selectedAccounts);
        if (!selectedAccountIds.length) { 
            if (typeof showNotification === 'function') {
                showNotification('Выберите аккаунты для ловца лидов', 'warning');
            } else {
                alert('Выберите аккаунты для ловца лидов');
            }
            return; 
        }
        const settings = {
            recipientsList: document.getElementById('recipients-list').value,
            triggerWords: document.getElementById('trigger-words').value,
            replyInChat: {
                enabled: document.getElementById('reply-in-chat').checked,
                message: document.getElementById('chat-reply-message').value,
                delay: document.getElementById('chat-reply-delay').value
            },
            forwardToStorage: {
                enabled: document.getElementById('forward-to-storage').checked,
                chatLink: document.getElementById('storage-chat-link').value
            },
            initiatePm: {
                enabled: document.getElementById('initiate-pm').checked,
                message: document.getElementById('pm-message').value,
                includeOriginal: document.getElementById('include-original').checked,
                delay: document.getElementById('pm-delay').value
            },
            addToGroup: {
                enabled: document.getElementById('add-to-group').checked,
                groupLink: document.getElementById('target-group-link').value,
                inviteMessage: document.getElementById('group-invite-message').value
            },
            aiConversation: {
                enabled: document.getElementById('ai-conversation').checked,
                agentId: document.getElementById('ai-agent-select').value
            },
            likeTriggers: {
                enabled: document.getElementById('like-triggers').checked,
                delay: document.getElementById('like-delay').value
            }
        };
        fetch('/start_leadcatcher_task', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ account_ids: selectedAccountIds, settings })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                if (typeof showNotification === 'function') {
                    showNotification('Ловец лидов запущен!', 'success');
                } else {
                alert('Ловец лидов запущен!');
                }
                hideModal('leadcatcherTaskModal');
                selectedAccounts.clear();
                updateSelectedAccountsCount();
            } else {
                if (typeof showNotification === 'function') {
                    showNotification('Ошибка запуска: ' + (data.error || 'Неизвестная ошибка'), 'error');
            } else {
                alert('Ошибка запуска: ' + (data.error || 'Неизвестная ошибка'));
            }
            }
        })
        .catch(err => { 
            console.error(err); 
            if (typeof showNotification === 'function') {
                showNotification('Ошибка при запуске: ' + err.message, 'error');
            } else {
                alert('Ошибка при запуске: ' + err.message);
            }
        });
    });
    // Легкая анимация кнопки запуска
    setTimeout(() => { document.getElementById('start-leadcatcher-btn').classList.add('pulse'); }, 1000);
});
// Тултипы
document.addEventListener('mouseover', function(e){
    if (e.target.closest('[data-tooltip]')) {
        const t = e.target.closest('[data-tooltip]').getAttribute('data-tooltip');
        const el = document.getElementById('customTooltip');
        el.textContent = t; el.style.left = (e.pageX+2)+'px'; el.style.top = (e.pageY-4)+'px'; el.classList.add('show');
    }
});
document.addEventListener('mouseout', function(e){ if (e.target.closest('[data-tooltip]')) document.getElementById('customTooltip').classList.remove('show'); });

// Обработчик для кнопки результатов ловца лидов
document.getElementById('btn-leadcatcher-results')?.addEventListener('click', function() {
    fetch('/api/open-folder?path=Файлы/Ловец лидов/Результаты')
        .then(response => {
            if (!response.ok) {
                return response.text().then(errorMessage => {
                    if (typeof showNotification === 'function') {
                        showNotification('Ошибка открытия папки: ' + errorMessage, 'error');
                    } else {
                        alert('Ошибка открытия папки: ' + errorMessage);
                    }
                });
            }
            if (typeof showNotification === 'function') {
                showNotification('Папка открыта', 'success');
            }
        })
        .catch(error => {
            console.error('Ошибка при открытии папки:', error);
            if (typeof showNotification === 'function') {
                showNotification('Ошибка при открытии папки: ' + error.message, 'error');
            } else {
                alert('Ошибка при открытии папки: ' + error.message);
            }
        });
});
</script>
{% endblock %}