{% extends "base.html" %}
{% block title %}Прокси{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/proxy.css') }}">
{% endblock %}

{% block content %}
<div class="proxy-page">
    <h1 class="page-title">Прокси</h1>
    
    <!-- Карточка с кнопками -->
    <div class="card">
        <div class="card-body">
            <div class="file-buttons-container">
                <button class="btn btn-light proxy-action-btn" id="proxyListBtn">
                    <svg class = "svg-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1">
                        <line x1="8" x2="21" y1="6" y2="6"></line>
                        <line x1="8" x2="21" y1="12" y2="12"></line>
                        <line x1="8" x2="21" y1="18" y2="18"></line>
                        <line x1="3" x2="3.01" y1="6" y2="6"></line>
                        <line x1="3" x2="3.01" y1="12" y2="12"></line>
                        <line x1="3" x2="3.01" y1="18" y2="18"></line>
                    </svg>
                    Список прокси
                </button>
                <button class="btn btn-light proxy-action-btn" id="buyProxyBtn">
                    <svg class = "svg-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1">
                        <path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z"></path>
                        <path d="m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z"></path>
                        <path d="M9 12H4s.55-3.03 2-4c1.62-1.08 5 0 5 0"></path>
                        <path d="M12 15v5s3.03-.55 4-2c1.08-1.62 0-5 0-5"></path>
                    </svg>
                    Купить прокси
                </button>
            </div>
        </div>
    </div>

    <!-- Карточка с дополнительными опциями -->
    <div class="card">
        <div class="card-body">
            <h3 class="subsection-title subsection-title-collapse collapsed" id="optionsHeader">
                Дополнительные опции
                <svg class = "svg-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4px" stroke-linecap="round" stroke-linejoin="round" class="collapse-chevron">
                    <path d="m6 9 6 6 6-6"></path>
                </svg>
            </h3>
            <div class="collapse" id="proxyOptions">
                <div class="options-container">
                    <div class="option-item">
                        <div class="option-label-container">
                            <label for="defaultProxyType" class="form-label">Тип прокси по умолчанию</label>
                            <span class="help-icon" data-tooltip="Чтобы определить тип прокси автоматически, нажмите &quot;Проверить прокси&quot; внизу страницы">
                                <svg class = "svg-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                                    <path d="M12 17h.01"></path>
                                </svg>
                            </span>
                        </div>
                        <select class="form-select" id="defaultProxyType">
                            <option value="socks">socks</option>
                            <option value="http" selected>http</option>
                        </select>
                    </div>
                    
                    <div class="option-item">
                        <div class="option-label-container">
                            <label for="ipVersion" class="form-label">Версия IP прокси</label>
                            <span class="help-icon" data-tooltip="При покупке IPv6 прокси вам должны выдать два адреса: IPv4 и IPv6. В этой настройке нужно будет выбрать IPv6, но вписывать в софт нужно именно IPv4.">
                                <svg class = "svg-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                                    <path d="M12 17h.01"></path>
                                </svg>
                            </span>
                        </div>
                        <select class="form-select" id="ipVersion">
                            <option value="IPv4" selected>IPv4</option>
                            <option value="IPv6">IPv6</option>
                        </select>
                    </div>
                    
                    <div class="option-item">
                        <div class="option-label-container">
                            <label for="randomOrder" class="form-label">Брать прокси в случайном порядке</label>
                            <span class="help-icon" data-tooltip="Если выключено, то будут браться по порядку.">
                                <svg class = "svg-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                                    <path d="M12 17h.01"></path>
                                </svg>
                            </span>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="randomOrder">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="start-task-btn-group">
    <button type="button" class="start-task-btn" id="start-task-btn">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polygon points="6 3 20 12 6 21 6 3"></polygon>
        </svg> Проверить прокси
    </button>
</div>

<!-- Модальное окно -->
<div class="modal" id="taskModal">
    <div class="modal-content">
        <div class="modal-footer">
            <button type="button" class="btn btn-primary btn-lg" id="do-start-task-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2">
                    <path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z"></path>
                    <path d="m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z"></path>
                    <path d="M9 12H4s.55-3.03 2-4c1.62-1.08 5 0 5 0"></path>
                    <path d="M12 15v5s3.03-.55 4-2c1.08-1.62 0-5 0-5"></path>
                </svg>
                <span>Запустить</span>
            </button>
        </div>
    </div>
</div>

<!-- Модальное окно для списка прокси -->
<div id="proxyListModal" class="proxy-modal">
    <div class="proxy-modal-overlay"></div>
    <div class="proxy-modal-dialog">
        <div class="proxy-modal-content">
            <div class="proxy-modal-header">
                <h5 class="proxy-modal-title">Список прокси</h5>
                <button type="button" class="btn-close" id="closeModalBtn">&times;</button>
            </div>
            <div class="proxy-modal-body">
                <!-- Информационный блок с форматами -->
                <div class="proxy-format-info">
                    <p>Допустимые форматы записи:</p>
                    <pre>ip:порт
ip:порт:логин:пароль
логин:пароль@ip:порт</pre>
                </div>

                <!-- Текстовая область для ввода прокси с номерами строк -->
                <div class="proxy-textarea-wrapper">
                    <div class="proxy-textarea-container">
                        <div class="line-numbers" id="lineNumbers"></div>
                        <textarea 
                            id="proxyListTextarea" 
                            class="proxy-textarea"
                            placeholder=""
                        ></textarea>
                    </div>
                </div>
            </div>
            
            <!-- Футер с поиском и количеством строк -->
            <div class="proxy-modal-footer">
                <div class="footer-left">
                    <!-- Кнопка поиска -->
                    <button class="search-toggle-btn" id="searchToggleBtn">
                        <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                        <span class="search-text">Поиск</span>
                    </button>
                    
                    <!-- Поле поиска (изначально скрыто) -->
                    <div class="search-container" id="searchContainer" style="display: none;">
                        <div class="search-input-wrapper">
                            <svg class="search-input-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="11" cy="11" r="8"></circle>
                                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                            </svg>
                            <input type="text" id="searchInput" class="search-input" placeholder="Введите текст для поиска...">
                            <button class="clear-search-btn" id="clearSearchBtn" style="display: none;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <span class="row-count">Кол-во строк: <span id="proxyLineCount">0</span></span>
                </div>
                <button class="btn btn-primary" id="saveBtn">Сохранить</button>
            </div>
        </div>
    </div>
</div>

<!-- Кастомный тултип -->
<div id="customTooltip" class="custom-tooltip"></div>

<script>
// Глобальные переменные
let originalProxyList = [];
let isSearchActive = false;

// Функции для работы с модальным окном
function openProxyListModal() {
    const modal = document.getElementById('proxyListModal');
    const textarea = document.getElementById('proxyListTextarea');
    
    modal.classList.add('show');
    
    // Сохраняем оригинальный список при открытии
    originalProxyList = textarea.value.split('\n');
    
    updateProxyLineCount();
    resetSearch();
}
// Добавьте в конец скрипта в proxy.html
window.openProxyListModal = openProxyListModal;
function closeProxyListModal() {
    const modal = document.getElementById('proxyListModal');
    modal.classList.remove('show');
    resetSearch();
}

function updateLineNumbers() {
    const textarea = document.getElementById('proxyListTextarea');
    const lineNumbers = document.getElementById('lineNumbers');
    
    const lineCount = textarea.value.split('\n').length;
    
    let numbers = [];
    for (let i = 1; i <= lineCount; i++) {
        numbers.push(i);
    }
    
    lineNumbers.textContent = numbers.join('\n');
    lineNumbers.scrollTop = textarea.scrollTop;
}

function updateProxyLineCount() {
    const textarea = document.getElementById('proxyListTextarea');
    const lines = textarea.value.split('\n').filter(line => line.trim() !== '');
    document.getElementById('proxyLineCount').textContent = lines.length;
    updateLineNumbers();
}

// Функции поиска
function toggleSearch() {
    if (isSearchActive) {
        hideSearch();
    } else {
        showSearch();
    }
}

function showSearch() {
    const searchContainer = document.getElementById('searchContainer');
    const searchToggleBtn = document.getElementById('searchToggleBtn');
    const searchInput = document.getElementById('searchInput');
    
    searchContainer.style.display = 'block';
    searchToggleBtn.classList.add('active');
    isSearchActive = true;
    
    setTimeout(() => {
        searchInput.focus();
    }, 100);
}

function hideSearch() {
    const searchContainer = document.getElementById('searchContainer');
    const searchToggleBtn = document.getElementById('searchToggleBtn');
    
    searchContainer.style.display = 'none';
    searchToggleBtn.classList.remove('active');
    isSearchActive = false;
    
    resetSearch();
}

function performSearch() {
    const searchInput = document.getElementById('searchInput');
    const searchTerm = searchInput.value.toLowerCase().trim();
    const textarea = document.getElementById('proxyListTextarea');
    const clearBtn = document.getElementById('clearSearchBtn');
    
    // Показываем/скрываем кнопку очистки
    clearBtn.style.display = searchTerm ? 'flex' : 'none';
    
    if (searchTerm === '') {
        // Восстанавливаем оригинальный список
        textarea.value = originalProxyList.join('\n');
    } else {
        // Фильтруем список
        const filteredList = originalProxyList.filter(line => 
            line.toLowerCase().includes(searchTerm)
        );
        textarea.value = filteredList.join('\n');
    }
    
    updateProxyLineCount();
}

function resetSearch() {
    const searchInput = document.getElementById('searchInput');
    const clearBtn = document.getElementById('clearSearchBtn');
    const textarea = document.getElementById('proxyListTextarea');
    
    searchInput.value = '';
    clearBtn.style.display = 'none';
    
    // Восстанавливаем оригинальный список
    textarea.value = originalProxyList.join('\n');
    updateProxyLineCount();
}

// Система уведомлений
class NotificationSystem {
    constructor() {
        this.container = null;
        this.init();
    }
    
    init() {
        this.container = document.createElement('div');
        this.container.className = 'notification-container';
        document.body.appendChild(this.container);
    }
    
    show(options) {
        const {
            title,
            message,
            type = 'info',
            duration = 5000
        } = options;
        
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        
        const iconSvg = this.getIcon(type);
        
        notification.innerHTML = `
            <div class="notification-icon">
                ${iconSvg}
            </div>
            <div class="notification-content">
                <div class="notification-title">${title}</div>
                <div class="notification-message">${message}</div>
            </div>
            <button class="notification-close">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        `;
        
        this.container.appendChild(notification);
        
        setTimeout(() => {
            notification.classList.add('show');
        }, 10);
        
        const closeBtn = notification.querySelector('.notification-close');
        closeBtn.addEventListener('click', () => {
            this.hide(notification);
        });
        
        if (duration > 0) {
            setTimeout(() => {
                this.hide(notification);
            }, duration);
        }
        
        return notification;
    }
    
    hide(notification) {
        notification.classList.remove('show');
        notification.classList.add('hide');
        
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 400);
    }
    
    getIcon(type) {
        const icons = {
            success: `
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#28a745" stroke-width="2">
                    <path d="M20 6L9 17l-5-5"/>
                </svg>
            `,
            error: `
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#dc3545" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="15" y1="9" x2="9" y2="15"></line>
                    <line x1="9" y1="9" x2="15" y2="15"></line>
                </svg>
            `,
            warning: `
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ffc107" stroke-width="2">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                    <line x1="12" y1="9" x2="12" y2="13"></line>
                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>
            `,
            info: `
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#5c8aff" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="16" x2="12" y2="12"></line>
                    <line x1="12" y1="8" x2="12.01" y2="8"></line>
                </svg>
            `
        };
        
        return icons[type] || icons.info;
    }
    
    success(title, message, duration = 5000) {
        return this.show({ title, message, type: 'success', duration });
    }
    
    error(title, message, duration = 5000) {
        return this.show({ title, message, type: 'error', duration });
    }
    
    warning(title, message, duration = 5000) {
        return this.show({ title, message, type: 'warning', duration });
    }
    
    info(title, message, duration = 5000) {
        return this.show({ title, message, type: 'info', duration });
    }
}

const notifications = new NotificationSystem();

function saveProxies() {
    const textarea = document.getElementById('proxyListTextarea');
    
    // Если поиск активен, сначала сбрасываем его
    if (isSearchActive && document.getElementById('searchInput').value.trim() !== '') {
        resetSearch();
    }
    
    const proxies = textarea.value.trim();
    
    if (proxies) {
        console.log('Сохранение прокси:', proxies);
        
        // Обновляем оригинальный список
        originalProxyList = textarea.value.split('\n');
        
        notifications.success(
            'Успешно!',
            'Прокси успешно сохранены',
            3000
        );
    } else {
        notifications.warning(
            'Внимание',
            'Список прокси пуст',
            3000
        );
    }
    
    closeProxyListModal();
}

function toggleOptions() {
    const optionsContent = document.getElementById('proxyOptions');
    const header = document.getElementById('optionsHeader');
    const chevron = header.querySelector('.collapse-chevron');
    
    optionsContent.classList.toggle('show');
    header.classList.toggle('collapsed');
    chevron.classList.toggle('rotated');
}

function showModal(modalId) {
    const modal = document.getElementById(modalId);
    modal.classList.add('show');
    modal.style.display = 'block';
}

function hideModal(modalId) {
    const modal = document.getElementById(modalId);
    modal.classList.remove('show');
    setTimeout(() => {
        modal.style.display = 'none';
    }, 1);
}

// Кастомные тултипы
document.addEventListener('mouseover', function(e) {
    if (e.target.closest('[data-tooltip]')) {
        const tooltipElement = e.target.closest('[data-tooltip]');
        const tooltipText = tooltipElement.getAttribute('data-tooltip');
        showTooltip(tooltipText, e.pageX, e.pageY);
    }
});

document.addEventListener('mouseout', function(e) {
    if (e.target.closest('[data-tooltip]')) {
        hideTooltip();
    }
});

function showTooltip(text, x, y) {
    const tooltip = document.getElementById('customTooltip');
    tooltip.textContent = text;
    tooltip.style.left = x + 2 + 'px';
    tooltip.style.top = y - 4 + 'px';
    tooltip.classList.add('show');
}

function hideTooltip() {
    const tooltip = document.getElementById('customTooltip');
    tooltip.classList.remove('show');
}

// Инициализация
document.addEventListener('DOMContentLoaded', function() {
    const textarea = document.getElementById('proxyListTextarea');
    const lineNumbers = document.getElementById('lineNumbers');
    const searchInput = document.getElementById('searchInput');
    const clearSearchBtn = document.getElementById('clearSearchBtn');
    const searchToggleBtn = document.getElementById('searchToggleBtn');
    
    // Инициализация
    updateLineNumbers();
    
    // Синхронизация прокрутки
    textarea.addEventListener('scroll', function() {
        lineNumbers.scrollTop = this.scrollTop;
    });
    
    // Обновление при изменении текста (только если поиск не активен)
    textarea.addEventListener('input', function() {
        if (!isSearchActive || document.getElementById('searchInput').value.trim() === '') {
            // Обновляем оригинальный список только если не идет поиск
            originalProxyList = textarea.value.split('\n');
        }
        updateProxyLineCount();
    });
    
    textarea.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            setTimeout(updateLineNumbers, 0);
        }
    });
    
    // Обработчики поиска
    searchInput.addEventListener('input', performSearch);
    
    searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            hideSearch();
        }
    });
    if (localStorage.getItem('open_proxy_modal') === 'true') {
        setTimeout(() => {
            openProxyListModal();
            localStorage.removeItem('open_proxy_modal'); // Очищаем флаг
        }, 1);
    }
    clearSearchBtn.addEventListener('click', resetSearch);
    searchToggleBtn.addEventListener('click', toggleSearch);
    
    // Кнопки действий
    document.getElementById('proxyListBtn').addEventListener('click', openProxyListModal);
    
    document.getElementById('buyProxyBtn').addEventListener('click', function() {
        window.open('https://x-rocket.ru', '_blank');
    });
    
    document.getElementById('closeModalBtn').addEventListener('click', closeProxyListModal);
    document.getElementById('saveBtn').addEventListener('click', saveProxies);
    
    document.getElementById('optionsHeader').addEventListener('click', toggleOptions);
    
    // Закрытие по оверлею
    const overlay = document.querySelector('.proxy-modal-overlay');
    if (overlay) {
        overlay.addEventListener('click', closeProxyListModal);
    }
    
    // Модальное окно задачи
    document.getElementById('start-task-btn').addEventListener('click', function() {
        showModal('taskModal');
    });
    
    document.getElementById('taskModal').addEventListener('click', function(e) {
        if (!e.target.closest('.modal-content')) {
            hideModal('taskModal');
        }
    });
});

// Стили для спиннера
const spinnerStyles = `
.spinner {
    width: 16px;
    height: 16px;
    border: 2px solid transparent;
    border-top: 2px solid #ffffff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    display: inline-block;
    margin-right: 8px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
`;

const styleSheet = document.createElement('style');
styleSheet.textContent = spinnerStyles;
document.head.appendChild(styleSheet);
</script>

{% endblock %}