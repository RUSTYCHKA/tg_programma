{% extends "base.html" %}
{% block title %}–ú–∞—Å—Å–ª—É–∫–∏–Ω–≥ —Å—Ç–æ—Ä–∏—Å{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/profile_edit.css') }}">
<style>
    /* –°—Ç–∏–ª–∏ –¥–ª—è –Ω–æ–≤—ã—Ö –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –º–∞—Å—Å–ª—É–∫–∏–Ω–≥–∞ */
    .masslook-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1050;
        overflow-x: hidden;
        overflow-y: auto;
        outline: 0;
    }
    .masslook-modal.show {
        display: block;
    }
    .masslook-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
    }
    .masslook-modal-dialog {
        position: relative;
        width: 100%;
        max-width: 900px;
        margin: 30px auto;
        pointer-events: none;
    }
    .masslook-modal-content {
        position: relative;
        display: flex;
        flex-direction: column;
        background-color: #252935;
        border: 1px solid #2a2e3a;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        pointer-events: auto;
        max-height: 85vh;
        overflow: hidden;
    }
    .masslook-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 24px;
        padding-bottom: 0;
        background-color: #252935;
    }
    .masslook-modal-title {
        margin: 0;
        font-size: 20px;
        font-weight: 500;
        color: #e0e0e0;
    }
    .btn-close {
        background: none;
        border: none;
        font-size: 28px;
        line-height: 1;
        color: #a0a0a0;
        cursor: pointer;
        padding: 0;
        margin: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        transition: all 0.2s;
    }
    .btn-close:hover {
        background-color: #3a3a3a;
        color: #ffffff;
    }
    .masslook-modal-body {
        padding: 24px;
        display: flex;
        flex-direction: column;
        gap: 16px;
        flex-grow: 1;
        background: #252935;
        overflow-y: auto;
    }
    .masslook-format-info {
        background-color: #1c1f28;
        padding: 14px 18px;
        border-radius: 8px;
        border-left: 4px solid #4067c5;
        font-size: 14px;
    }
    .masslook-format-info p {
        margin: 0 0 10px 0;
        font-weight: 500;
        color: #e0e0e0;
    }
    .masslook-format-info pre {
        margin: 0;
        font-family: 'Courier New', Courier, monospace;
        white-space: pre-wrap;
        word-break: break-all;
        color: #a0a0a0;
        font-size: 13px;
        line-height: 1.6;
    }
    .masslook-textarea-wrapper {
        position: relative;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
    }
    .masslook-textarea-container {
        position: relative;
        flex-grow: 1;
        display: flex;
        background-color: #1c1f28;
        border: 1px solid #2a2e3a;
        border-radius: 8px;
        overflow: hidden;
    }
    .line-numbers {
        background-color: #1a1d26;
        color: #6c757d;
        padding: 12px 12px 12px 8px;
        text-align: right;
        font-family: 'Courier New', Courier, monospace;
        font-size: 14px;
        line-height: 21px;
        user-select: none;
        border-right: 1px solid #2a2e3a;
        min-width: 50px;
        overflow: hidden;
        white-space: pre;
    }
    .masslook-textarea {
        width: 100%;
        min-height: 350px;
        resize: none;
        padding: 12px 12px 12px 8px;
        font-family: 'Courier New', Courier, monospace;
        font-size: 14px;
        line-height: 21px;
        border: none;
        box-sizing: border-box;
        background-color: #1c1f28;
        color: #e0e0e0;
        flex-grow: 1;
        overflow-y: auto;
        overflow-x: auto;
    }
    .masslook-textarea:focus {
        outline: none;
    }
    .masslook-textarea::placeholder {
        color: #6c757d;
        opacity: 1;
    }
    .masslook-modal-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 24px;
        background-color: #252935;
        border-top: 1px solid #2a2e3a;
    }
    .footer-left {
        display: flex;
        align-items: center;
        gap: 16px;
    }
    .search-toggle-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        background: linear-gradient(145deg, #5c8aff, #4c7cff);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 14px;
        font-weight: 500;
    }
    .search-toggle-btn:hover {
        background: linear-gradient(145deg, #4c7cff, #3f6fd3);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(92, 138, 255, 0.3);
    }
    .search-toggle-btn.active {
        background: linear-gradient(145deg, #3f6fd3, #2f5ba0);
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    .search-toggle-btn .search-icon {
        width: 16px;
        height: 16px;
    }
    .search-toggle-btn .search-text {
        white-space: nowrap;
    }
    .search-container {
        display: flex;
        align-items: center;
        background-color: #1c1f28;
        border: 1px solid #2a2e3a;
        border-radius: 8px;
        padding: 6px 12px;
        min-width: 280px;
        margin-left: 8px;
    }
    .search-input-wrapper {
        position: relative;
        display: flex;
        align-items: center;
        width: 100%;
    }
    .search-input-icon {
        color: #6c757d;
        margin-right: 8px;
        flex-shrink: 0;
        width: 16px;
        height: 16px;
    }
    .search-input {
        background: transparent;
        border: none;
        color: #e0e0e0;
        font-size: 14px;
        flex: 1;
        outline: none;
        padding: 4px 0;
    }
    .search-input::placeholder {
        color: #6c757d;
    }
    .clear-search-btn {
        background: none;
        border: none;
        color: #6c757d;
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        display: none;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        margin-left: 4px;
    }
    .clear-search-btn:hover {
        background-color: #2a2e3a;
        color: #e0e0e0;
    }
    .row-count {
        font-size: 14px;
        color: #a0a0a0;
        margin-left: 16px;
    }
</style>
{% endblock %}

{% block content %}
<div class="proxy-page">
    <h1 class="page-title">–ú–∞—Å—Å–ª—É–∫–∏–Ω–≥ —Å—Ç–æ—Ä–∏—Å</h1>

    <!-- –ö–Ω–æ–ø–∫–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤/—Ñ–∞–π–ª–æ–≤ -->
    <div class="card">
        <div class="card-body">
            <div class="file-buttons-container">
                <button class="btn btn-light" id="btn-users-base">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    –ë–∞–∑–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                    <span class="section-button-counter ms-1" id="counter-users">0</span>
                    <span class="help-icon" data-tooltip="–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, —Å—Ç–æ—Ä–∏—Å –∫–æ—Ç–æ—Ä—ã—Ö –Ω—É–∂–Ω–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å.">
                        <svg class="svg-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                                <path d="M12 17h.01"></path>
                            </svg>
                    </span>
                </button>
                <button class="btn btn-light" id="btn-chats-base">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                    –ë–∞–∑–∞ —á–∞—Ç–æ–≤
                    <span class="section-button-counter ms-1" id="counter-chats">0</span>
                    <span class="help-icon" data-tooltip="–°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤, —Å—Ç–æ—Ä–∏—Å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∫–æ—Ç–æ—Ä—ã—Ö –Ω—É–∂–Ω–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å.">
                        <svg class="svg-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                                <path d="M12 17h.01"></path>
                            </svg>
                    </span>
                </button>
            </div>
        </div>
    </div>

    <div class="module-description-container alert alert-primary mb-4" data-section-id="stories_mass_looking_and_liking">
        –ë–∞–∑–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π - –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –º–∞—Å—Å–ª—É–∫–∏–Ω–≥ –ø–æ –ª—é–¥—è–º.
        –ë–∞–∑–∞ —á–∞—Ç–æ–≤ - –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –º–∞—Å—Å–ª—É–∫–∏–Ω–≥ –ø–æ —á–∞—Ç–∞–º.
        –í—ã–±–∏—Ä–∞–π—Ç–µ –æ–¥–∏–Ω –∏–∑ —ç—Ç–∏—Ö —Ä–µ–∂–∏–º–æ–≤!
    </div>

    <!-- –†–µ–∞–∫—Ü–∏–∏ –Ω–∞ —Å—Ç–æ—Ä–∏—Å -->
    <div class="card">
        <div class="card-body">
            <h3 class="subsection-title">–†–µ–∞–∫—Ü–∏–∏ –Ω–∞ —Å—Ç–æ—Ä–∏—Å</h3>
            
            <div class="options-container">
                <div>
                    <label for="sendReactions" class="form-label">–û—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ä–µ–∞–∫—Ü–∏–∏ –Ω–∞ —Å—Ç–æ—Ä–∏—Å</label>
                    <span class="help-icon" data-tooltip="–ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ, —Ç–æ –≤ –¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –∫ –ø—Ä–æ—Å–º–æ—Ç—Ä—É —Å—Ç–æ—Ä–∏—Å –∞–∫–∫–∞—É–Ω—Ç—ã –±—É–¥—É—Ç —Å—Ç–∞–≤–∏—Ç—å –Ω–∞ –Ω–∏—Ö –æ–¥–Ω—É –∏–∑ —Ä–µ–∞–∫—Ü–∏–π, —É–∫–∞–∑–∞–Ω–Ω—ã—Ö –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –Ω–∏–∂–µ.">
                        <svg class="svg-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                                <path d="M12 17h.01"></path>
                            </svg>
                    </span>
                    <div class="input-group">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="sendReactions" checked>
                        </div>
                        <div class="invalid-feedback" id="invalid-feedback-for-sendReactions"></div>
                    </div>
                </div>
                <div>
                    <label for="storyReactions" class="form-label">–†–µ–∞–∫—Ü–∏–∏ –Ω–∞ —Å—Ç–æ—Ä–∏—Å</label>
                    <span class="help-icon" data-tooltip="–ï—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –≤—ã—à–µ –≤–∫–ª—é—á–µ–Ω–∞, —Ç–æ –¥–∞–Ω–Ω—ã–µ —Ä–µ–∞–∫—Ü–∏–∏ –±—É–¥—É—Ç —Å—Ç–∞–≤–∏—Ç—Å—è –Ω–∞ —Å—Ç–æ—Ä–∏—Å. –†–µ–∞–∫—Ü–∏—è –±—É–¥–µ—Ç –≤—ã–±—Ä–∞–Ω–∞ —Å–ª—É—á–∞–π–Ω–æ.">
                        <svg class="svg-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                                <path d="M12 17h.01"></path>
                            </svg>
                    </span>
                    <div class="input-group">
                        <input class="form-control rounded-end" id="storyReactions" spellcheck="false" autocomplete="off" placeholder="" value="‚ù§Ô∏èüëçüî•">
                        <div class="invalid-feedback" id="invalid-feedback-for-storyReactions"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –†–∞–∑–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
    <div class="card">
        <div class="card-body">
            <h3 class="subsection-title subsection-title-collapse collapsed" id="miscSettingsHeader">
                –†–∞–∑–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                <svg class="svg-icon collapse-chevron" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4px" stroke-linecap="round" stroke-linejoin="round">
                    <path d="m6 9 6 6 6-6"></path>
                </svg>
            </h3>
            <div class="collapse" id="miscSettingsOptions">
                <div class="options-container">
                    <div>
                        <label for="actionDelay" class="form-label">–ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –¥–µ–π—Å—Ç–≤–∏—è–º–∏</label>
                        <span class="help-icon" data-tooltip="–ú–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –¥–∏–∞–ø–∞–∑–æ–Ω. –ù–∞–ø—Ä–∏–º–µ—Ä &quot;5-20&quot;">
<svg class="svg-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                                <path d="M12 17h.01"></path>
                            </svg>
                        </span>
                        <div class="input-group" style="max-width: 200px">
                            <input class="form-control has-trailing-label" id="actionDelay" spellcheck="false" autocomplete="off" placeholder="" value="2-5">
                            <span class="input-trailing-label">—Å–µ–∫</span>
                            <div class="invalid-feedback" id="invalid-feedback-for-actionDelay"></div>
                        </div>
                    </div>
                    <div>
                        <label for="storiesPerAccount" class="form-label">–°–∫–æ–ª—å–∫–æ —Å—Ç–æ—Ä–∏—Å —Å–º–æ—Ç—Ä–µ—Ç—å —Å –∫–∞–∂–¥–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞</label>
                        <span class="help-icon" data-tooltip="–ú–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –¥–∏–∞–ø–∞–∑–æ–Ω. –ù–∞–ø—Ä–∏–º–µ—Ä &quot;5-20&quot;">
<svg class="svg-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                                <path d="M12 17h.01"></path>
                            </svg>
                        </span>
                        <div class="input-group" style="max-width: 200px">
                            <input class="form-control has-trailing-label" id="storiesPerAccount" spellcheck="false" autocomplete="off" placeholder="" value="100-200">
                            <span class="input-trailing-label">—à—Ç</span>
                            <div class="invalid-feedback" id="invalid-feedback-for-storiesPerAccount"></div>
                        </div>
                    </div>
                    <div>
                        <label for="storiesPerUser" class="form-label">–°–∫–æ–ª—å–∫–æ —Å—Ç–æ—Ä–∏—Å —Å–º–æ—Ç—Ä–µ—Ç—å —É –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                        <span class="help-icon" data-tooltip="–ß—Ç–æ–±—ã —Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ —Å—Ç–æ—Ä–∏—Å, –±–µ–∑ –ª–∏–º–∏—Ç–∞, –≤–ø–∏—à–∏—Ç–µ 99999.<br>–ú–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –¥–∏–∞–ø–∞–∑–æ–Ω. –ù–∞–ø—Ä–∏–º–µ—Ä &quot;5-20&quot;">
<svg class="svg-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                                <path d="M12 17h.01"></path>
                            </svg>
                        </span>
                        <div class="input-group" style="max-width: 200px">
                            <input class="form-control has-trailing-label" id="storiesPerUser" spellcheck="false" autocomplete="off" placeholder="" value="3">
                            <span class="input-trailing-label">—à—Ç</span>
                            <div class="invalid-feedback" id="invalid-feedback-for-storiesPerUser"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- –ö–Ω–æ–ø–∫–∞ –∑–∞–ø—É—Å–∫–∞ -->
<div class="start-task-btn-group">
    <button type="button" class="start-task-btn" id="start-masslook-btn">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polygon points="6 3 20 12 6 21 6 3"></polygon>
        </svg>
        –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∞—Å—Å–ª—É–∫
    </button>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∑–∞–ø—É—Å–∫–∞ -->
<div class="modal" id="masslookTaskModal">
    <div class="modal-content">
        <div class="modal-body">
            <div class="options-container">
                <div class="mb-4">
                    <button class="btn btn-primary w-100" id="select-accounts-btn">
                        <span>–ê–∫–∫–∞—É–Ω—Ç—ã</span>
                        <span class="mx-1 opacity-50">|</span>
                        <span id="accounts-picked-for-task-count">0</span>
                    </button>
                </div>
                <div>
                    <label for="threadCount" class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ç–æ–∫–æ–≤</label>
                    <span class="help-icon ms-1" data-tooltip="–°–∫–æ–ª—å–∫–æ –∞–∫–∫–∞—É–Ω—Ç–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ.">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                            <path d="M12 17h.01"></path>
                        </svg>
                    </span>
                    <div class="input-group">
                        <input class="form-control" id="threadCount" type="number" min="1" max="50" value="1">
                        <div class="invalid-feedback" id="invalid-feedback-for-threadCount"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-primary btn-lg" id="do-start-masslook-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2">
                    <path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z"></path>
                    <path d="m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z"></path>
                    <path d="M9 12H4s.55-3.03 2-4c1.62-1.08 5 0 5 0"></path>
                    <path d="M12 15v5s3.03-.55 4-2c1.08-1.62 0-5 0-5"></path>
                </svg>
                <span>–ó–∞–ø—É—Å—Ç–∏—Ç—å</span>
            </button>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ –∞–∫–∫–∞—É–Ω—Ç–æ–≤ -->
<div class="modal" id="accountsModal" style="display: none;">
    <div class="modal-content" style="width: 90%; max-width: 1200px; height: 80vh;">
        <div class="modal-header">
            <h5 class="modal-title">–í—ã–±–æ—Ä –∞–∫–∫–∞—É–Ω—Ç–æ–≤</h5>
            <button type="button" class="modal-close" id="accountsModalClose">&times;</button>
        </div>
        <div class="modal-body" style="height: calc(100% - 120px); overflow: hidden;">
            <div class="proxy-container" style="height: 100%;">
                <div class="header-section">
                    <div class="table-controls">
                        <div class="account-folder-selector">
                            <button class="account-folder-btn active" id="all-folder-accounts">
                                <div class="account-count" data-count="0">0</div>
                                <div class="account-label">–í—Å–µ –∞–∫–∫–∞—É–Ω—Ç—ã</div>
                                <div class="active-indicator"></div>
                            </button>
                            <button class="account-folder-btn" id="working-folder-accounts">
                                <div class="account-count" data-count="0">0</div>
                                <div class="account-label">–î–ª—è —Ä–∞–±–æ—Ç—ã</div>
                                <div class="active-indicator"></div>
                            </button>
                            <button class="account-folder-btn" id="archive-folder-accounts">
                                <div class="account-count" data-count="0">0</div>
                                <div class="account-label">–ê—Ä—Ö–∏–≤</div>
                                <div class="active-indicator"></div>
                            </button>
                            <button class="account-folder-btn" id="no-spam-folder-accounts">
                                <div class="account-count" data-count="0">0</div>
                                <div class="account-label">–ë–µ–∑ —Å–ø–∞–º–±–ª–æ–∫–∞</div>
                                <div class="active-indicator"></div>
                            </button>
                            <button class="account-folder-btn" id="with-spam-folder-accounts">
                                <div class="account-count" data-count="0">0</div>
                                <div class="account-label">–°–ø–∞–º–±–ª–æ–∫</div>
                                <div class="active-indicator"></div>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card mb-3">
                    <div class="card-body p-3 d-flex align-items-center">
                        <div class="d-flex gap-2">
                            <button class="btn btn-light" id="select-all-accounts-modal">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 7 17l-5-5"></path><path d="m22 10-7.5 7.5L13 16"></path></svg>
                            </button>
                            <button id="deselect-all-btn-modal" type="button" class="btn btn-light">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg>
                            </button>
                        </div>
                        <span class="text-muted ms-auto" id="accounts-count-label-modal">–ü–æ–∫–∞–∑–∞–Ω–æ –∞–∫–∫–∞—É–Ω—Ç–æ–≤: 0 / 0</span>
                    </div>
                </div>

                <div style="height: calc(100% - 200px); overflow-y: auto;">
                    <table id="accounts-table-modal" class="proxy-table">
                        <thead>
                            <tr>
                                <th class="selector-header"><input type="checkbox" id="select-all-checkbox-modal" class="select-all-checkbox"></th>
                                <th>#</th>
                                <th>–ê–≤–∞—Ç–∞—Ä</th>
                                <th><div class="sortable-header" data-sort="phone">–¢–µ–ª–µ—Ñ–æ–Ω<div class="sort-icons"><span class="sort-asc">‚ñ≤</span><span class="sort-desc">‚ñº</span></div></div></th>
                                <th><div class="sortable-header" data-sort="geo">–ì–µ–æ<div class="sort-icons"><span class="sort-asc">‚ñ≤</span><span class="sort-desc">‚ñº</span></div></div></th>
                                <th><div class="sortable-header" data-sort="status">–°—Ç–∞—Ç—É—Å<div class="sort-icons"><span class="sort-asc">‚ñ≤</span><span class="sort-desc">‚ñº</span></div></div></th>
                                <th>–û—Ç–ª–µ–∂–∫–∞</th>
                                <th><div class="sortable-header" data-sort="role">–†–æ–ª—å<div class="sort-icons"><span class="sort-asc">‚ñ≤</span><span class="sort-desc">‚ñº</span></div></div></th>
                                <th>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω</th>
                                <th><div class="sortable-header" data-sort="name">–ò–º—è<div class="sort-icons"><span class="sort-asc">‚ñ≤</span><span class="sort-desc">‚ñº</span></div></div></th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" id="accountsModalCancel">–û—Ç–º–µ–Ω–∞</button>
            <button type="button" class="btn btn-primary" id="confirmAccountsSelection">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å (<span id="selected-count-modal">0</span>)</button>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –±–∞–∑—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
<div id="usersBaseModal" class="masslook-modal">
    <div class="masslook-modal-overlay"></div>
    <div class="masslook-modal-dialog">
        <div class="masslook-modal-content">
            <div class="masslook-modal-header">
                <h5 class="masslook-modal-title">–ë–∞–∑–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h5>
                <button type="button" class="btn-close" id="closeUsersBaseModalBtn">&times;</button>
            </div>
            <div class="masslook-modal-body">
                <div class="masslook-format-info">
                    <p>–í–≤–µ–¥–∏—Ç–µ —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–ø–æ –æ–¥–Ω–æ–π –≤ —Å—Ç—Ä–æ–∫–µ):</p>
                    <pre>username
@username
user_id</pre>
                </div>
                <div class="masslook-textarea-wrapper">
                    <div class="masslook-textarea-container">
                        <div class="line-numbers" id="lineNumbersUsers"></div>
                        <textarea
                            id="usersBaseTextarea"
                            class="masslook-textarea"
                            placeholder="–í–≤–µ–¥–∏—Ç–µ —é–∑–µ—Ä–Ω–µ–π–º—ã –∏–ª–∏ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π..."
                        ></textarea>
                    </div>
                </div>
            </div>
            <div class="masslook-modal-footer">
                <div class="footer-left">
                    <button class="search-toggle-btn" id="searchToggleUsers">
                        <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                        <span class="search-text">–ü–æ–∏—Å–∫</span>
                    </button>
                    <div class="search-container" id="searchContainerUsers" style="display: none;">
                        <div class="search-input-wrapper">
                            <svg class="search-input-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="11" cy="11" r="8"></circle>
                                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                            </svg>
                            <input type="text" id="searchInputUsers" class="search-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞...">
                            <button class="clear-search-btn" id="clearSearchUsers" style="display: none;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <span class="row-count">–ö–æ–ª-–≤–æ —Å—Ç—Ä–æ–∫: <span id="usersBaseLineCount">0</span></span>
                </div>
                <button class="btn btn-primary" id="saveUsersBaseBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –±–∞–∑—ã —á–∞—Ç–æ–≤ -->
<div id="chatsBaseModal" class="masslook-modal">
    <div class="masslook-modal-overlay"></div>
    <div class="masslook-modal-dialog">
        <div class="masslook-modal-content">
            <div class="masslook-modal-header">
                <h5 class="masslook-modal-title">–ë–∞–∑–∞ —á–∞—Ç–æ–≤</h5>
                <button type="button" class="btn-close" id="closeChatsBaseModalBtn">&times;</button>
            </div>
            <div class="masslook-modal-body">
                <div class="masslook-format-info">
                    <p>–í–≤–µ–¥–∏—Ç–µ —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ (–ø–æ –æ–¥–Ω–æ–π –≤ —Å—Ç—Ä–æ–∫–µ):</p>
                    <pre>https://t.me/chatname
chatusername
https://t.me/joinchat/invite_link</pre>
                </div>
                <div class="masslook-textarea-wrapper">
                    <div class="masslook-textarea-container">
                        <div class="line-numbers" id="lineNumbersChats"></div>
                        <textarea
                            id="chatsBaseTextarea"
                            class="masslook-textarea"
                            placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫–∏ –∏–ª–∏ —é–∑–µ—Ä–Ω–µ–π–º—ã —á–∞—Ç–æ–≤..."
                        ></textarea>
                    </div>
                </div>
            </div>
            <div class="masslook-modal-footer">
                <div class="footer-left">
                    <button class="search-toggle-btn" id="searchToggleChats">
                        <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                        <span class="search-text">–ü–æ–∏—Å–∫</span>
                    </button>
                    <div class="search-container" id="searchContainerChats" style="display: none;">
                        <div class="search-input-wrapper">
                            <svg class="search-input-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="11" cy="11" r="8"></circle>
                                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                            </svg>
                            <input type="text" id="searchInputChats" class="search-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞...">
                            <button class="clear-search-btn" id="clearSearchChats" style="display: none;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <span class="row-count">–ö–æ–ª-–≤–æ —Å—Ç—Ä–æ–∫: <span id="chatsBaseLineCount">0</span></span>
                </div>
                <button class="btn btn-primary" id="saveChatsBaseBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<div id="customTooltip" class="custom-tooltip"></div>
{% endblock %}

{% block extra_js %}

<script>
// –õ–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –º–æ–¥–∞–ª–∫–∏ (–∫–∞–∫ –≤ parsing.html)
let selectedAccounts = new Set();
let allAccounts = [];
let currentFolder = 'all';
let currentSpamFilter = null;
let currentBaseType = 'users'; // users | chats

// --- –ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–æ–¥–∞–ª—å–Ω—ã–º–∏ –æ–∫–Ω–∞–º–∏ –±–∞–∑—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π/—á–∞—Ç–æ–≤ ---
// --- –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–ø–∏—Å–∫–æ–≤ ---
let masslookLists = {
    users: [],
    chats: []
};

// --- –°–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π ---
class NotificationSystem {
    constructor() {
        this.container = null;
        this.init();
    }
    init() {
        this.container = document.createElement('div');
        this.container.className = 'notification-container';
        document.body.appendChild(this.container);
    }
    show(options) {
        const {
            title,
            message,
            type = 'info',
            duration = 5000
        } = options;
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        const iconSvg = this.getIcon(type);
        notification.innerHTML = `
            <div class="notification-icon">
                ${iconSvg}
            </div>
            <div class="notification-content">
                <div class="notification-title">${title}</div>
                <div class="notification-message">${message}</div>
            </div>
            <button class="notification-close">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        `;
        this.container.appendChild(notification);
        setTimeout(() => {
            notification.classList.add('show');
        }, 10);
        const closeBtn = notification.querySelector('.notification-close');
        closeBtn.addEventListener('click', () => {
            this.hide(notification);
        });
        if (duration > 0) {
            setTimeout(() => {
                this.hide(notification);
            }, duration);
        }
        return notification;
    }
    hide(notification) {
        notification.classList.remove('show');
        notification.classList.add('hide');
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 400);
    }
    getIcon(type) {
        const icons = {
            success: `
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#28a745" stroke-width="2">
                    <path d="M20 6L9 17l-5-5"/>
                </svg>
            `,
            error: `
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#dc3545" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="15" y1="9" x2="9" y2="15"></line>
                    <line x1="9" y1="9" x2="15" y2="15"></line>
                </svg>
            `,
            warning: `
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ffc107" stroke-width="2">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                    <line x1="12" y1="9" x2="12" y2="13"></line>
                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>
            `,
            info: `
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#5c8aff" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="16" x2="12" y2="12"></line>
                    <line x1="12" y1="8" x2="12.01" y2="8"></line>
                </svg>
            `
        };
        return icons[type] || icons.info;
    }
    success(title, message, duration = 5000) {
        return this.show({ title, message, type: 'success', duration });
    }
    error(title, message, duration = 5000) {
        return this.show({ title, message, type: 'error', duration });
    }
    warning(title, message, duration = 5000) {
        return this.show({ title, message, type: 'warning', duration });
    }
    info(title, message, duration = 5000) {
        return this.show({ title, message, type: 'info', duration });
    }
}
const notifications = new NotificationSystem();

// --- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–æ–¥–∞–ª—å–Ω—ã–º–∏ –æ–∫–Ω–∞–º–∏ ---
function openModal(modalId, listKey, textareaId, lineNumbersId, lineCountId) {
    const modal = document.getElementById(modalId);
    const textarea = document.getElementById(textareaId);
    modal.classList.add('show');
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
    textarea.value = masslookLists[listKey].join('\n');
    updateLineNumbers(lineNumbersId, textareaId);
    updateLineCount(lineCountId, textareaId);
    resetSearch(listKey);
}

function closeModal(modalId, listKey) {
    const modal = document.getElementById(modalId);
    modal.classList.remove('show');
    resetSearch(listKey);
}

function updateLineNumbers(lineNumbersId, textareaId) {
    const textarea = document.getElementById(textareaId);
    const lineNumbers = document.getElementById(lineNumbersId);
    const lineCount = textarea.value.split('\n').length;
    let numbers = [];
    for (let i = 1; i <= lineCount; i++) {
        numbers.push(i);
    }
    lineNumbers.textContent = numbers.join('\n');
    lineNumbers.scrollTop = textarea.scrollTop;
}

function updateLineCount(lineCountId, textareaId) {
    const textarea = document.getElementById(textareaId);
    const lines = textarea.value.split('\n').filter(line => line.trim() !== '');
    document.getElementById(lineCountId).textContent = lines.length;
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —Å—á–µ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏
    if (lineCountId === 'usersBaseLineCount') {
        document.getElementById('counter-users').textContent = lines.length;
    } else if (lineCountId === 'chatsBaseLineCount') {
        document.getElementById('counter-chats').textContent = lines.length;
    }
}

// --- –§—É–Ω–∫—Ü–∏–∏ –ø–æ–∏—Å–∫–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ ---
let searchStates = {
    users: { active: false, originalList: [] },
    chats: { active: false, originalList: [] }
};

function toggleSearch(listKey) {
    if (searchStates[listKey].active) {
        hideSearch(listKey);
    } else {
        showSearch(listKey);
    }
}

function showSearch(listKey) {
    const searchContainerId = `searchContainer${listKey.charAt(0).toUpperCase() + listKey.slice(1)}`;
    const searchToggleBtnId = `searchToggle${listKey.charAt(0).toUpperCase() + listKey.slice(1)}`;
    const searchInputId = `searchInput${listKey.charAt(0).toUpperCase() + listKey.slice(1)}`;
    const searchContainer = document.getElementById(searchContainerId);
    const searchToggleBtn = document.getElementById(searchToggleBtnId);
    const searchInput = document.getElementById(searchInputId);

    searchContainer.style.display = 'block';
    searchToggleBtn.classList.add('active');
    searchStates[listKey].active = true;
    setTimeout(() => {
        searchInput.focus();
    }, 100);
}

function hideSearch(listKey) {
    const searchContainerId = `searchContainer${listKey.charAt(0).toUpperCase() + listKey.slice(1)}`;
    const searchToggleBtnId = `searchToggle${listKey.charAt(0).toUpperCase() + listKey.slice(1)}`;
    const searchContainer = document.getElementById(searchContainerId);
    const searchToggleBtn = document.getElementById(searchToggleBtnId);

    searchContainer.style.display = 'none';
    searchToggleBtn.classList.remove('active');
    searchStates[listKey].active = false;
    resetSearch(listKey);
}

function performSearch(listKey) {
    const searchInputId = `searchInput${listKey.charAt(0).toUpperCase() + listKey.slice(1)}`;
    const textareaId = `${listKey}Textarea`;
    const clearBtnId = `clearSearch${listKey.charAt(0).toUpperCase() + listKey.slice(1)}`;
    const searchInput = document.getElementById(searchInputId);
    const searchTerm = searchInput.value.toLowerCase().trim();
    const textarea = document.getElementById(textareaId);
    const clearBtn = document.getElementById(clearBtnId);

    clearBtn.style.display = searchTerm ? 'flex' : 'none';

    if (searchTerm === '') {
        textarea.value = searchStates[listKey].originalList.join('\n');
    } else {
        const filteredList = searchStates[listKey].originalList.filter(line =>
            line.toLowerCase().includes(searchTerm)
        );
        textarea.value = filteredList.join('\n');
    }
    const lineCountId = `${listKey}LineCount`;
    updateLineCount(lineCountId, textareaId);
}

function resetSearch(listKey) {
    const searchInputId = `searchInput${listKey.charAt(0).toUpperCase() + listKey.slice(1)}`;
    const textareaId = `${listKey}Textarea`;
    const clearBtnId = `clearSearch${listKey.charAt(0).toUpperCase() + listKey.slice(1)}`;
    const searchInput = document.getElementById(searchInputId);
    const clearBtn = document.getElementById(clearBtnId);
    const textarea = document.getElementById(textareaId);

    searchInput.value = '';
    clearBtn.style.display = 'none';
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫
    textarea.value = masslookLists[listKey].join('\n'); // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫
    const lineCountId = `${listKey}LineCount`;
    updateLineCount(lineCountId, textareaId);
}

function saveList(listKey, textareaId, modalId) {
    const textarea = document.getElementById(textareaId);
    // –ï—Å–ª–∏ –ø–æ–∏—Å–∫ –∞–∫—Ç–∏–≤–µ–Ω, —Å–Ω–∞—á–∞–ª–∞ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –µ–≥–æ
    const searchInputId = `searchInput${listKey.charAt(0).toUpperCase() + listKey.slice(1)}`;
    if (searchStates[listKey].active && document.getElementById(searchInputId).value.trim() !== '') {
        resetSearch(listKey);
    }
    const list = textarea.value.trim();
    if (list) {
        console.log(`–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ ${listKey}:`, list);
        masslookLists[listKey] = textarea.value.split('\n');
        notifications.success('–£—Å–ø–µ—à–Ω–æ!', `–°–ø–∏—Å–æ–∫ ${listKey} —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω`, 3000);
    } else {
        notifications.warning('–í–Ω–∏–º–∞–Ω–∏–µ', `–°–ø–∏—Å–æ–∫ ${listKey} –ø—É—Å—Ç`, 3000);
    }
    closeModal(modalId, listKey);
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
    const lineCountId = `${listKey}LineCount`;
    updateLineCount(lineCountId, textareaId);
}

function showModal(modalId){
  const el = document.getElementById(modalId);
  if (!el) return;
  el.classList.add('show');
  el.style.display = 'block';
}
function hideModal(modalId){
  const el = document.getElementById(modalId);
  if (!el) return;
  el.classList.remove('show');
  setTimeout(()=>{ el.style.display = 'none'; }, 300);
}

function updateSelectedAccountsCount(){
  const el = document.getElementById('accounts-picked-for-task-count');
  if (el) el.textContent = selectedAccounts.size;
  const el2 = document.getElementById('selected-count-modal');
  if (el2) el2.textContent = selectedAccounts.size;
}

async function loadAccounts(folder = 'all'){
  try {
    const response = await fetch('/get_accounts', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ folder })
    });
    if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–æ–≤');
    allAccounts = await response.json();
    renderAccountsTable();
    updateAccountsCountLabel();
  } catch (e) { console.error(e); }
}

function getStatusClass(status){
  switch(status){
    case 'alive': return 'alive';
    case 'dead': return 'dead';
    case 'spam_block': return 'spam-block';
    default: return 'unknown';
  }
}
function getStatusText(status){
  switch(status){
    case 'alive': return '–ë–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π';
    case 'dead': return '–ú–µ—Ä—Ç–≤';
    case 'spam_block': return '–°–ø–∞–º –±–ª–æ–∫';
    default: return '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
  }
}
function getCountryData(){ return { RU:{name:'–†–æ—Å—Å–∏—è'}, UA:{name:'–£–∫—Ä–∞–∏–Ω–∞'}, KZ:{name:'–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω'}, US:{name:'–°–®–ê'} }; }
function getCountryInfo(code){ const m=getCountryData(); return m[code]||{name:code||'–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}; }
function getFlagEmoji(code){ if(!code) return 'üè≥Ô∏è'; const cps=code.toUpperCase().split('').map(c=>127397+c.charCodeAt(0)); try{ return String.fromCodePoint(...cps);}catch(e){return 'üè≥Ô∏è';} }

function renderAccountsTable(){
  const tbody = document.querySelector('#accounts-table-modal tbody');
  if (!tbody) return;
  tbody.innerHTML = (allAccounts||[]).map((account, index)=>{
    const fullName = `${account.first_name||''} ${account.last_name||''}`.trim();
    const countryInfo = getCountryInfo(account.geo);
    const flagEmoji = getFlagEmoji(account.geo);
    return `
      <tr data-account-id="${account.id}" class="account-row">
        <td><input type="checkbox" class="account-checkbox" data-account-id="${account.id}" ${selectedAccounts.has(account.id)?'checked':''}></td>
        <td>${index+1}</td>
        <td class="avatar-cell"><div class="avatar-placeholder">${(account.first_name||account.last_name||'?').toString().charAt(0).toUpperCase()}</div></td>
        <td>${account.phone||''}</td>
        <td><div class="geo-cell" title="${countryInfo.name}"><span class="country-flag">${flagEmoji}</span><span class="country-code">${account.geo||''}</span></div></td>
        <td><span class="status-badge ${getStatusClass(account.status)}">${getStatusText(account.status)}</span></td>
        <td class="rest-period" data="${account.register_time}">${account.rest_until||'-'}</td>
        <td>${account.role||''}</td>
        <td>${account.last_used||'–ù–µ—Ç'}</td>
        <td>${fullName||''}</td>
      </tr>
    `;
  }).join('');

  document.querySelectorAll('.account-checkbox').forEach(cb=>{
    cb.addEventListener('change', function(){
      const id = this.dataset.accountId;
      if (this.checked) selectedAccounts.add(id); else selectedAccounts.delete(id);
      updateSelectedAccountsCount();
    });
  });
}

function updateAccountsCountLabel(){
  const total = allAccounts.length;
  const displayed = document.querySelectorAll('#accounts-table-modal tbody tr').length;
  const el = document.getElementById('accounts-count-label-modal');
  if (el) el.textContent = `–ü–æ–∫–∞–∑–∞–Ω–æ –∞–∫–∫–∞—É–Ω—Ç–æ–≤: ${displayed} / ${total}`;
}

function toggleSection(headerId, contentId){
  const content = document.getElementById(contentId);
  const header = document.getElementById(headerId);
  const chevron = header?.querySelector('.collapse-chevron');
  if (!content || !header || !chevron) return;
  content.classList.toggle('show');
  header.classList.toggle('collapsed');
  chevron.classList.toggle('rotated');
}

document.addEventListener('DOMContentLoaded', function(){
  // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω ---
    document.getElementById('btn-users-base').addEventListener('click', function() {
        openModal('usersBaseModal', 'users', 'usersBaseTextarea', 'lineNumbersUsers', 'usersBaseLineCount');
        currentBaseType = 'users'; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∏–ø –±–∞–∑—ã –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
    });
    document.getElementById('btn-chats-base').addEventListener('click', function() {
        openModal('chatsBaseModal', 'chats', 'chatsBaseTextarea', 'lineNumbersChats', 'chatsBaseLineCount');
        currentBaseType = 'chats'; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∏–ø –±–∞–∑—ã –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
    });

    // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω ---
    document.getElementById('closeUsersBaseModalBtn').addEventListener('click', function() { closeModal('usersBaseModal', 'users'); });
    document.getElementById('closeChatsBaseModalBtn').addEventListener('click', function() { closeModal('chatsBaseModal', 'chats'); });

    // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è ---
    document.getElementById('saveUsersBaseBtn').addEventListener('click', function() { saveList('users', 'usersBaseTextarea', 'usersBaseModal'); });
    document.getElementById('saveChatsBaseBtn').addEventListener('click', function() { saveList('chats', 'chatsBaseTextarea', 'chatsBaseModal'); });

    // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—è ---
    const textareas = [
        { id: 'usersBaseTextarea', lineNumbersId: 'lineNumbersUsers', listKey: 'users', counterId: 'counter-users' },
        { id: 'chatsBaseTextarea', lineNumbersId: 'lineNumbersChats', listKey: 'chats', counterId: 'counter-chats' }
    ];

    textareas.forEach(item => {
        const textarea = document.getElementById(item.id);
        const lineNumbers = document.getElementById(item.lineNumbersId);

        updateLineNumbers(item.lineNumbersId, item.id);

        textarea.addEventListener('scroll', function() {
            lineNumbers.scrollTop = this.scrollTop;
        });

        textarea.addEventListener('input', function() {
            if (!searchStates[item.listKey].active || document.getElementById(`searchInput${item.listKey.charAt(0).toUpperCase() + item.listKey.slice(1)}`).value.trim() === '') {
                masslookLists[item.listKey] = textarea.value.split('\n');
            }
            updateLineCount(`${item.listKey}LineCount`, item.id);
        });

        textarea.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                setTimeout(() => updateLineNumbers(item.lineNumbersId, item.id), 0);
            }
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–æ–∏—Å–∫–∞
        const searchInput = document.getElementById(`searchInput${item.listKey.charAt(0).toUpperCase() + item.listKey.slice(1)}`);
        searchInput.addEventListener('input', function() { performSearch(item.listKey); });
        searchInput.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                hideSearch(item.listKey);
            }
        });

        const clearSearchBtn = document.getElementById(`clearSearch${item.listKey.charAt(0).toUpperCase() + item.listKey.slice(1)}`);
        clearSearchBtn.addEventListener('click', function() { resetSearch(item.listKey); });

        const searchToggleBtn = document.getElementById(`searchToggle${item.listKey.charAt(0).toUpperCase() + item.listKey.slice(1)}`);
        searchToggleBtn.addEventListener('click', function() { toggleSearch(item.listKey); });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –æ–≤–µ—Ä–ª–µ—é
        const overlay = document.querySelector(`#${item.listKey.charAt(0).toUpperCase() + item.listKey.slice(1)}Modal .masslook-modal-overlay`);
        if (overlay) {
            overlay.addEventListener('click', function() { closeModal(`${item.listKey.charAt(0).toUpperCase() + item.listKey.slice(1)}Modal`, item.listKey); });
        }
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    updateLineCount('usersBaseLineCount', 'usersBaseTextarea');
    updateLineCount('chatsBaseLineCount', 'chatsBaseTextarea');

  // –í—ã–±–æ—Ä —Ç–∏–ø–∞ –±–∞–∑—ã
  // document.getElementById('btn-users-base')?.addEventListener('click', ()=>{ currentBaseType='users'; });
  // document.getElementById('btn-chats-base')?.addEventListener('click', ()=>{ currentBaseType='chats'; });

  // –ö–Ω–æ–ø–∫–∞ –∑–∞–ø—É—Å–∫–∞
  document.getElementById('start-masslook-btn')?.addEventListener('click', function(){ showModal('masslookTaskModal'); });
  document.getElementById('masslookTaskModal')?.addEventListener('click', function(e){ if (e.target === this) hideModal('masslookTaskModal'); });

  // –û—Ç–∫—Ä—ã—Ç–∏–µ –≤—ã–±–æ—Ä–∞ –∞–∫–∫–∞—É–Ω—Ç–æ–≤
  document.getElementById('select-accounts-btn')?.addEventListener('click', function(){
    hideModal('masslookTaskModal');
    showModal('accountsModal');
    loadAccounts();
  });

  // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–æ–≤
  document.getElementById('accountsModalClose')?.addEventListener('click', ()=> hideModal('accountsModal'));
  document.getElementById('accountsModalCancel')?.addEventListener('click', ()=> hideModal('accountsModal'));
  document.getElementById('accountsModal')?.addEventListener('click', function(e){ if (e.target === this) hideModal('accountsModal'); });
  document.getElementById('confirmAccountsSelection')?.addEventListener('click', function(){ hideModal('accountsModal'); showModal('masslookTaskModal'); });

  // –°–µ–ª–µ–∫—Ç–æ—Ä—ã –ø–∞–ø–æ–∫ –∏ —Å–ø–∞–º-—Ñ–∏–ª—å—Ç—Ä–æ–≤
  document.getElementById('all-folder-accounts')?.addEventListener('click', ()=>{ currentFolder='all'; loadAccounts('all'); });
  document.getElementById('working-folder-accounts')?.addEventListener('click', ()=>{ currentFolder='working'; loadAccounts('working'); });
  document.getElementById('archive-folder-accounts')?.addEventListener('click', ()=>{ currentFolder='archive'; loadAccounts('archive'); });
  document.getElementById('no-spam-folder-accounts')?.addEventListener('click', ()=>{ currentSpamFilter='no-spam'; loadAccounts(currentFolder); });
  document.getElementById('with-spam-folder-accounts')?.addEventListener('click', ()=>{ currentSpamFilter='with-spam'; loadAccounts(currentFolder); });

  // –í—ã–¥–µ–ª–µ–Ω–∏—è
  document.getElementById('select-all-accounts-modal')?.addEventListener('click', function(){
    document.querySelectorAll('.account-checkbox').forEach(checkbox=>{
      const id = checkbox.getAttribute('data-account-id');
      selectedAccounts.add(id);
      checkbox.checked = true;
    });
    updateSelectedAccountsCount();
  });
  document.getElementById('deselect-all-btn-modal')?.addEventListener('click', function(){
    selectedAccounts.clear();
    document.querySelectorAll('.account-checkbox').forEach(checkbox=>{ checkbox.checked = false; });
    updateSelectedAccountsCount();
  });
  const selectAllCheckbox = document.getElementById('select-all-checkbox-modal');
  if (selectAllCheckbox){
    selectAllCheckbox.addEventListener('change', function(){
      if (this.checked){
        document.getElementById('select-all-accounts-modal')?.click();
      } else {
        document.getElementById('deselect-all-btn-modal')?.click();
      }
    });
  }

  // –¢–æ–≥–≥–ª—ã —Å–µ–∫—Ü–∏–π
  document.getElementById('miscSettingsHeader')?.addEventListener('click', ()=> toggleSection('miscSettingsHeader','miscSettingsOptions'));

  // –ó–∞–ø—É—Å–∫ –∑–∞–¥–∞—á–∏
  document.getElementById('do-start-masslook-btn')?.addEventListener('click', function(){
    const threadCount = parseInt(document.getElementById('threadCount').value, 10);
    const selectedAccountIds = Array.from(selectedAccounts);
    if (!selectedAccountIds.length){ alert('–í—ã–±–µ—Ä–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç—ã'); return; }
    if (!threadCount || threadCount < 1 || threadCount > 50){ alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ç–æ–∫–æ–≤ (1-50)'); return; }

    const settings = {
      baseType: currentBaseType, // users | chats
      sendReactions: document.getElementById('sendReactions').checked,
      storyReactions: (document.getElementById('storyReactions').value||'').trim(),
      delays: {
        action: (document.getElementById('actionDelay').value||'').trim(),
      },
      limits: {
        perAccountStories: (document.getElementById('storiesPerAccount').value||'').trim(),
        perUserStories: (document.getElementById('storiesPerUser').value||'').trim()
      }
    };

    fetch('/start_masslook_task', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ account_ids: selectedAccountIds, thread_count: threadCount, settings })
    })
    .then(r=>r.json())
    .then(data=>{
      if (data.success){
        alert('–ú–∞—Å—Å–ª—É–∫ –∑–∞–ø—É—â–µ–Ω!');
        hideModal('masslookTaskModal');
        selectedAccounts.clear();
        updateSelectedAccountsCount();
      } else {
        alert('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
      }
    })
    .catch(err=>{ console.error(err); alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ: ' + err.message); });
  });

  // –ù–µ–±–æ–ª—å—à–∞—è –∞–Ω–∏–º–∞—Ü–∏—è
  setTimeout(()=>{ document.getElementById('start-masslook-btn')?.classList.add('pulse'); }, 1000);
});

document.addEventListener('mouseover', function(e) {
    if (e.target.closest('[data-tooltip]')) {
        const tooltipElement = e.target.closest('[data-tooltip]');
        const tooltipText = tooltipElement.getAttribute('data-tooltip');
        showTooltip(tooltipText, e.pageX, e.pageY);
    }
});

document.addEventListener('mouseout', function(e) {
    if (e.target.closest('[data-tooltip]')) {
        hideTooltip();
    }
});

function showTooltip(text, x, y) {
    const tooltip = document.getElementById('customTooltip');
    tooltip.textContent = text;
    tooltip.style.left = x + 2 + 'px';
    tooltip.style.top = y - 4 + 'px';
    tooltip.classList.add('show');
}

function hideTooltip() {
    const tooltip = document.getElementById('customTooltip');
    tooltip.classList.remove('show');
}
</script>
{% endblock %}